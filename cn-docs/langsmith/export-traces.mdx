---
title: 查询追踪（SDK）
sidebarTitle: Query traces (SDK)
---
<Tip>
**推荐阅读**

在深入阅读本内容之前，建议先阅读以下内容：

- [运行（span）数据格式](/langsmith/run-data-format)
- <RegionalUrl type="api" suffix="/redoc" text="LangSmith API 参考" />
- [LangSmith 追踪查询语法](/langsmith/trace-query-syntax)

</Tip>

<Note>
**如果您需要导出大量追踪数据，我们建议使用[批量数据导出](./data-export)功能，因为它能更好地处理大数据量，并支持跨分区的自动重试和并行化。**
</Note>

查询运行（LangSmith 追踪中的 span 数据）的推荐方式是使用 SDK 中的 `list_runs` 方法或 API 中的 `/runs/query` 端点。

LangSmith 以 [运行（span）数据格式](/langsmith/run-data-format) 中规定的简单格式存储追踪。

## 使用过滤参数

对于简单的查询，您不必依赖我们的查询语法。您可以使用 [过滤参数参考](/langsmith/trace-query-syntax#filter-arguments) 中指定的过滤参数。

<Warning>
**前提条件**

在运行以下代码片段之前，请先初始化客户端。
</Warning>

<CodeGroup>

```python Python
from langsmith import Client

client = Client()
```

```typescript TypeScript
import { Client, Run } from "langsmith";

const client = new Client();
```

</CodeGroup>

以下是一些使用关键字参数列出运行的方式示例：

### 列出项目中的所有运行

<CodeGroup>

```python Python
project_runs = client.list_runs(project_name="<your_project>")
```

```typescript TypeScript
// Download runs in a project
const projectRuns: Run[] = [];
for await (const run of client.listRuns({
  projectName: "<your_project>",
})) {
  projectRuns.push(run);
};
```

</CodeGroup>

### 列出过去 24 小时内的 LLM 和 Chat 运行

<CodeGroup>

```python Python
todays_llm_runs = client.list_runs(
    project_name="<your_project>",
    start_time=datetime.now() - timedelta(days=1),
    run_type="llm",
)
```

```typescript TypeScript
const todaysLlmRuns: Run[] = [];
for await (const run of client.listRuns({
  projectName: "<your_project>",
  startTime: new Date(Date.now() - 1000 * 60 * 60 * 24),
  runType: "llm",
})) {
  todaysLlmRuns.push(run);
};
```

</CodeGroup>

### 列出项目中的根运行

根运行是没有父级的运行。这些运行的 `is_root` 值被设置为 `True`。您可以使用此属性来过滤根运行。

<CodeGroup>

```python Python
root_runs = client.list_runs(
    project_name="<your_project>",
    is_root=True
)
```

```typescript TypeScript
const rootRuns: Run[] = [];
for await (const run of client.listRuns({
  projectName: "<your_project>",
  isRoot: 1,
})) {
  rootRuns.push(run);
};
```

</CodeGroup>

### 列出没有错误的运行

<CodeGroup>

```python Python
correct_runs = client.list_runs(project_name="<your_project>", error=False)
```

```typescript TypeScript
const correctRuns: Run[] = [];
for await (const run of client.listRuns({
  projectName: "<your_project>",
  error: false,
})) {
  correctRuns.push(run);
};
```

</CodeGroup>

### 按运行 ID 列出运行

<Warning>
**忽略其他参数**

如果您按上述方式提供运行 ID 列表，它将忽略所有其他过滤参数，如 `project_name`、`run_type` 等，并直接返回与给定 ID 匹配的运行。
</Warning>

如果您有一个运行 ID 列表，可以直接列出它们：

<CodeGroup>

```python Python
run_ids = ['a36092d2-4ad5-4fb4-9c0d-0dba9a2ed836','9398e6be-964f-4aa4-8ae9-ad78cd4b7074']
selected_runs = client.list_runs(id=run_ids)
```

```typescript TypeScript
const runIds = [
  "a36092d2-4ad5-4fb4-9c0d-0dba9a2ed836",
  "9398e6be-964f-4aa4-8ae9-ad78cd4b7074",
];
const selectedRuns: Run[] = [];
for await (const run of client.listRuns({
  id: runIds,
})) {
  selectedRuns.push(run);
};
```

</CodeGroup>

### 按 ID 获取单个运行

要按 ID 获取单个运行（追踪），请使用 `read_run` 方法。当您有一个特定的追踪 ID（例如，来自 LangSmith 分享链接，如 `https://smith.langchain.com/public/<trace-id>/r`）并希望检索其完整数据时，这非常有用。

<CodeGroup>

```python Python
run_id = "a36092d2-4ad5-4fb4-9c0d-0dba9a2ed836"
run = client.read_run(run_id)

# Access run data
print(run.inputs)
print(run.outputs)
print(run.name)
```

```typescript TypeScript
const runId = "a36092d2-4ad5-4fb4-9c0d-0dba9a2ed836";
const run = await client.readRun(runId);

// Access run data
console.log(run.inputs);
console.log(run.outputs);
console.log(run.name);
```

</CodeGroup>

<Tip>
    **使用 LangGraph 在本地重放追踪**

    如果您在使用带检查点的 LangGraph，可以从 LangSmith 获取追踪并在本地重放以进行调试。有关从检查点恢复执行的详细信息，请参阅 [LangGraph 的时间旅行和重放文档](/oss/langgraph/use-time-travel)。
</Tip>

## 使用过滤查询语言

对于更复杂的查询，您可以使用 [过滤查询语言参考](/langsmith/trace-query-syntax#filter-query-language) 中描述的查询语言。

### 列出对话线程中的所有根运行

这是获取对话线程中运行的方法。有关设置线程的更多信息，请参阅我们的 [如何设置线程指南](./threads)。
线程通过设置共享的线程 ID 进行分组。LangSmith UI 允许您使用以下三个元数据键中的任何一个：`session_id`、`conversation_id` 或 `thread_id`。会话 ID 也称为追踪项目 ID。以下查询匹配其中任何一个。

<CodeGroup>

```python Python
group_key = "<your_thread_id>"
filter_string = f'and(in(metadata_key, ["session_id","conversation_id","thread_id"]), eq(metadata_value, "{group_key}"))'
thread_runs = client.list_runs(
    project_name="<your_project>",
    filter=filter_string,
    is_root=True
)
```

```typescript TypeScript
const groupKey = "<your_thread_id>";
const filterString = `and(in(metadata_key, ["session_id","conversation_id","thread_id"]), eq(metadata_value, "${groupKey}"))`;
const threadRuns: Run[] = [];
for await (const run of client.listRuns({
  projectName: "<your_project>",
  filter: filterString,
  isRoot: true
})) {
  threadRuns.push(run);
};
```

</CodeGroup>

### 列出所有名为 "extractor" 且其追踪根运行被分配了反馈 "user_score" 分数为 1 的运行

<CodeGroup>

```python Python
client.list_runs(
    project_name="<your_project>",
    filter='eq(name, "extractor")',
    trace_filter='and(eq(feedback_key, "user_score"), eq(feedback_score, 1))'
)
```

```typescript TypeScript
client.listRuns({
  projectName: "<your_project>",
  filter: 'eq(name, "extractor")',
  traceFilter: 'and(eq(feedback_key, "user_score"), eq(feedback_score, 1))'
})
```

</CodeGroup>

### 列出 "star_rating" 键的分数大于 4 的运行

<CodeGroup>

```python Python
client.list_runs(
    project_name="<your_project>",
    filter='and(eq(feedback_key, "star_rating"), gt(feedback_score, 4))'
)
```

```typescript TypeScript
client.listRuns({
  projectName: "<your_project>",
  filter: 'and(eq(feedback_key, "star_rating"), gt(feedback_score, 4))'
})
```

</CodeGroup>

### 列出完成时间超过 5 秒的运行

<CodeGroup>

```python Python
client.list_runs(project_name="<your_project>", filter='gt(latency, "5s")')
```

```typescript TypeScript
client.listRuns({projectName: "<your_project>", filter: 'gt(latency, "5s")'})
```
</CodeGroup>
### 列出所有 "error" 不等于 null 的运行

<CodeGroup>

```python Python
client.list_runs(project_name="<your_project>", filter='neq(error, null)')
```

```typescript TypeScript
client.listRuns({projectName: "<your_project>", filter: 'neq(error, null)'})
```

</CodeGroup>

### 列出所有 start_time 大于特定时间戳的运行

<CodeGroup>

```python Python
client.list_runs(project_name="<your_project>", filter='gt(start_time, "2023-07-15T12:34:56Z")')
```

```typescript TypeScript
client.listRuns({projectName: "<your_project>", filter: 'gt(start_time, "2023-07-15T12:34:56Z")'})
```

</CodeGroup>

### 列出所有包含字符串 "substring" 的运行

<CodeGroup>

```python Python
client.list_runs(project_name="<your_project>", filter='search("substring")')
```

```typescript TypeScript
client.listRuns({projectName: "<your_project>", filter: 'search("substring")'})
```

</CodeGroup>

### 列出所有标记有 git 哈希 "2aa1cf4" 的运行

<CodeGroup>

```python Python
client.list_runs(project_name="<your_project>", filter='has(tags, "2aa1cf4")')
```

```typescript TypeScript
client.listRuns({projectName: "<your_project>", filter: 'has(tags, "2aa1cf4")'})
```

</CodeGroup>

### 列出所有在特定时间戳之后开始且 "error" 不等于 null 或 "Correctness" 反馈分数等于 0 的运行

<CodeGroup>

```python Python
client.list_runs(
  project_name="<your_project>",
  filter='and(gt(start_time, "2023-07-15T12:34:56Z"), or(neq(error, null), and(eq(feedback_key, "Correctness"), eq(feedback_score, 0.0))))'
)
```

```typescript TypeScript
client.listRuns({
  projectName: "<your_project>",
  filter: 'and(gt(start_time, "2023-07-15T12:34:56Z"), or(neq(error, null), and(eq(feedback_key, "Correctness"), eq(feedback_score, 0.0))))'
})
```

</CodeGroup>

### 复杂查询：列出所有标签包含 "experimental" 或 "beta" 且延迟大于 2 秒的运行

<CodeGroup>

```python Python
client.list_runs(
  project_name="<your_project>",
  filter='and(or(has(tags, "experimental"), has(tags, "beta")), gt(latency, 2))'
)
```

```typescript TypeScript
client.listRuns({
  projectName: "<your_project>",
  filter: 'and(or(has(tags, "experimental"), has(tags, "beta")), gt(latency, 2))'
})
```

</CodeGroup>

### 通过全文搜索追踪树

您可以使用不带任何特定字段的 `search()` 函数，在运行的所有字符串字段中进行全文搜索。这使您可以快速找到与搜索词匹配的追踪。

<CodeGroup>

```python Python
client.list_runs(
  project_name="<your_project>",
  filter='search("image classification")'
)
```

```typescript TypeScript
client.listRuns({
  projectName: "<your_project>",
  filter: 'search("image classification")'
})
```

</CodeGroup>

### 检查元数据是否存在

如果您想检查元数据是否存在，可以使用 `eq` 运算符，可选地结合 `and` 语句来匹配值。如果您想记录关于运行的更结构化信息，这非常有用。

<CodeGroup>

```python Python
to_search = {
    "user_id": ""
}

# Check for any run with the "user_id" metadata key
client.list_runs(
  project_name="default",
  filter="eq(metadata_key, 'user_id')"
)
# Check for runs with user_id=4070f233-f61e-44eb-bff1-da3c163895a3
client.list_runs(
  project_name="default",
  filter="and(eq(metadata_key, 'user_id'), eq(metadata_value, '4070f233-f61e-44eb-bff1-da3c163895a3'))"
)
```

```typescript TypeScript
// Check for any run with the "user_id" metadata key
client.listRuns({
  projectName: 'default',
  filter: `eq(metadata_key, 'user_id')`
});
// Check for runs with user_id=4070f233-f61e-44eb-bff1-da3c163895a3
client.listRuns({
  projectName: 'default',
  filter: `and(eq(metadata_key, 'user_id'), eq(metadata_value, '4070f233-f61e-44eb-bff1-da3c163895a3'))`
});
```

</CodeGroup>

### 检查元数据中的环境详细信息

一种常见模式是通过元数据将环境信息添加到您的追踪中。如果您想过滤包含环境元数据的运行，可以使用与上述相同的模式：

<CodeGroup>

```python Python
client.list_runs(
  project_name="default",
  filter="and(eq(metadata_key, 'environment'), eq(metadata_value, 'production'))"
)
```

```typescript TypeScript
client.listRuns({
  projectName: 'default',
  filter: `and(eq(metadata_key, 'environment'), eq(metadata_value, 'production'))`
});
```

</CodeGroup>

### 检查元数据中的对话 ID

关联同一对话中追踪的另一种常见方式是使用共享的对话 ID。如果您想以这种方式基于对话 ID 过滤运行，可以在元数据中搜索该 ID。

<CodeGroup>

```python Python
client.list_runs(
  project_name="default",
  filter="and(eq(metadata_key, 'conversation_id'), eq(metadata_value, 'a1b2c3d4-e5f6-7890'))"
)
```

```typescript TypeScript
client.listRuns({
  projectName: 'default',
  filter: `and(eq(metadata_key, 'conversation_id'), eq(metadata_value, 'a1b2c3d4-e5f6-7890'))`
});
```

</CodeGroup>

### 对键值对进行负向过滤

您可以在元数据、输入和输出键值对上使用负向过滤，从结果中排除特定的运行。以下是一些针对元数据键值对的示例，但同样的逻辑也适用于输入和输出键值对。

<CodeGroup>

```python Python
# Find all runs where the metadata does not contain a "conversation_id" key
client.list_runs(
  project_name="default",
  filter="and(neq(metadata_key, 'conversation_id'))"
)

# Find all runs where the conversation_id in metadata is not "a1b2c3d4-e5f6-7890"
client.list_runs(
  project_name="default",
  filter="and(eq(metadata_key, 'conversation_id'), neq(metadata_value, 'a1b2c3d4-e5f6-7890'))"
)

# Find all runs where there is no "conversation_id" metadata key and the "a1b2c3d4-e5f6-7890" value is not present
client.list_runs(
  project_name="default",
  filter="and(neq(metadata_key, 'conversation_id'), neq(metadata_value, 'a1b2c3d4-e5f6-7890'))"
)

# Find all runs where the conversation_id metadata key is not present but the "a1b2c3d4-e5f6-7890" value is present
client.list_runs(
  project_name="default",
  filter="and(neq(metadata_key, 'conversation_id'), eq(metadata_value, 'a1b2c3d4-e5f6-7890'))"
)
```

```typescript TypeScript
// Find all runs where the metadata does not contain a "conversation_id" key
client.listRuns({
  projectName: 'default',
  filter: `and(neq(metadata_key, 'conversation_id'))`
});

// Find all runs where the conversation_id in metadata is not "a1b2c3d4-e5f6-7890"
client.listRuns({
  projectName: 'default',
  filter: `and(eq(metadata_key, 'conversation_id'), neq(metadata_value, 'a1b2c3d4-e5f6-7890'))`
});

// Find all runs where there is no "conversation_id" metadata key and the "a1b2c3d4-e5f6-7890" value is not present
client.listRuns({
  projectName: 'default',
  filter: `and(neq(metadata_key, 'conversation_id'), neq(metadata_value, 'a1b2c3d4-e5f6-7890'))`
});

// Find all runs where the conversation_id metadata key is not present but the "a1b2c3d4-e5f6-7890" value is present
client.listRuns({
  projectName: 'default',
  filter: `and(neq(
