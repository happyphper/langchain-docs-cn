---
title: æ„å»ºå¸¦æœ‰äººå·¥è½¬æ¥çš„å®¢æˆ·æ”¯æŒç³»ç»Ÿ
sidebarTitle: 'Handoffs: Customer support'
---
import ChatModelTabsPy from '/snippets/chat-model-tabs.mdx';
import ChatModelTabsJs from '/snippets/chat-model-tabs-js.mdx';

[çŠ¶æ€æœºæ¨¡å¼](/oss/langchain/multi-agent/handoffs)æè¿°äº†æ™ºèƒ½ä½“åœ¨ä»»åŠ¡çš„ä¸åŒçŠ¶æ€é—´ç§»åŠ¨æ—¶å…¶è¡Œä¸ºå‘ç”Ÿå˜åŒ–çš„å·¥ä½œæµã€‚æœ¬æ•™ç¨‹å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ä½¿ç”¨å·¥å…·è°ƒç”¨æ¥åŠ¨æ€æ›´æ”¹å•ä¸ªæ™ºèƒ½ä½“çš„é…ç½®ï¼Œä»è€ŒåŸºäºå½“å‰çŠ¶æ€å®ç°çŠ¶æ€æœºâ€”â€”æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–°å…¶å¯ç”¨å·¥å…·å’ŒæŒ‡ä»¤ã€‚çŠ¶æ€å¯ä»¥ç”±å¤šä¸ªæ¥æºç¡®å®šï¼šæ™ºèƒ½ä½“çš„è¿‡å¾€æ“ä½œï¼ˆå·¥å…·è°ƒç”¨ï¼‰ã€å¤–éƒ¨çŠ¶æ€ï¼ˆä¾‹å¦‚ API è°ƒç”¨ç»“æœï¼‰ï¼Œç”šè‡³åˆå§‹ç”¨æˆ·è¾“å…¥ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡è¿è¡Œåˆ†ç±»å™¨æ¥ç¡®å®šç”¨æˆ·æ„å›¾ï¼‰ã€‚

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œä½ å°†æ„å»ºä¸€ä¸ªå®¢æˆ·æ”¯æŒæ™ºèƒ½ä½“ï¼Œå…¶åŠŸèƒ½å¦‚ä¸‹ï¼š

- åœ¨ç»§ç»­ä¹‹å‰æ”¶é›†ä¿ä¿®ä¿¡æ¯ã€‚
- å°†é—®é¢˜åˆ†ç±»ä¸ºç¡¬ä»¶æˆ–è½¯ä»¶é—®é¢˜ã€‚
- æä¾›è§£å†³æ–¹æ¡ˆæˆ–å‡çº§åˆ°äººå·¥æ”¯æŒã€‚
- åœ¨å¤šè½®å¯¹è¯ä¸­ç»´æŠ¤ä¼šè¯çŠ¶æ€ã€‚

ä¸[å­æ™ºèƒ½ä½“æ¨¡å¼](/oss/langchain/multi-agent/subagents-personal-assistant)ï¼ˆå…¶ä¸­å­æ™ºèƒ½ä½“ä½œä¸ºå·¥å…·è¢«è°ƒç”¨ï¼‰ä¸åŒï¼Œ**çŠ¶æ€æœºæ¨¡å¼**ä½¿ç”¨å•ä¸ªæ™ºèƒ½ä½“ï¼Œå…¶é…ç½®æ ¹æ®å·¥ä½œæµè¿›åº¦è€Œå˜åŒ–ã€‚æ¯ä¸ªâ€œæ­¥éª¤â€åªæ˜¯åŒä¸€ä¸ªåº•å±‚æ™ºèƒ½ä½“çš„ä¸åŒé…ç½®ï¼ˆç³»ç»Ÿæç¤ºè¯ + å·¥å…·ï¼‰ï¼Œæ ¹æ®çŠ¶æ€åŠ¨æ€é€‰æ‹©ã€‚

ä»¥ä¸‹æ˜¯æˆ‘ä»¬å°†è¦æ„å»ºçš„å·¥ä½œæµï¼š

```mermaid
%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#4CAF50','primaryTextColor':'#fff','primaryBorderColor':'#2E7D32','lineColor':'#666','secondaryColor':'#FF9800','tertiaryColor':'#2196F3'}}}%%
flowchart TD
    %% Start
    Start([ğŸ’¬ Customer reports<br>an issue]) --> Warranty{Is the device<br>under warranty?}

    %% Warranty check
    Warranty -->|âœ… Yes| IssueType{What type<br>of issue?}
    Warranty -->|âŒ No| OutOfWarranty{What type<br>of issue?}

    %% In-Warranty branch
    IssueType -->|ğŸ”© Hardware| Repair[Provide warranty<br>repair instructions]
    IssueType -->|ğŸ’» Software| Troubleshoot[Provide troubleshooting<br>steps]

    %% Out-of-Warranty branch
    OutOfWarranty -->|ğŸ”© Hardware| Escalate[Escalate to human<br>for paid repair options]
    OutOfWarranty -->|ğŸ’» Software| Troubleshoot

    %% Troubleshooting follow-up
    Troubleshoot --> Close([âœ… Issue Resolved])
    Repair --> Close
    Escalate --> Close

    %% === Styling ===
    classDef startEnd fill:#4CAF50,stroke:#2E7D32,stroke-width:2px,color:#fff
    classDef decisionNode fill:#2196F3,stroke:#1565C0,stroke-width:2px,color:#fff
    classDef actionNode fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    classDef escalateNode fill:#f44336,stroke:#c62828,stroke-width:2px,color:#fff

    class Start,Close startEnd
    class Warranty,IssueType,OutOfWarranty decisionNode
    class Repair,Troubleshoot actionNode
    class Escalate escalateNode
```

## è®¾ç½®

### å®‰è£…

æœ¬æ•™ç¨‹éœ€è¦ `langchain` åŒ…ï¼š

:::python
<CodeGroup>
```bash pip
pip install langchain
```
```bash uv
uv add langchain
```
```bash conda
conda install langchain -c conda-forge
```
</CodeGroup>
:::

:::js
<CodeGroup>
```bash npm
npm install langchain
```
```bash yarn
yarn add langchain
```
```bash pnpm
pnpm add langchain
```
</CodeGroup>
:::

æ›´å¤šè¯¦æƒ…ï¼Œè¯·å‚é˜…æˆ‘ä»¬çš„[å®‰è£…æŒ‡å—](/oss/langchain/install)ã€‚

### LangSmith

è®¾ç½® [LangSmith](https://smith.langchain.com) ä»¥æ£€æŸ¥æ™ºèƒ½ä½“å†…éƒ¨å‘ç”Ÿçš„æƒ…å†µã€‚ç„¶åè®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

:::python
<CodeGroup>
```bash bash
export LANGSMITH_TRACING="true"
export LANGSMITH_API_KEY="..."
```
```python python
import getpass
import os

os.environ["LANGSMITH_TRACING"] = "true"
os.environ["LANGSMITH_API_KEY"] = getpass.getpass()
```
</CodeGroup>
:::

:::js
<CodeGroup>
```bash bash
export LANGSMITH_TRACING="true"
export LANGSMITH_API_KEY="..."
```
```typescript typescript
process.env.LANGSMITH_TRACING = "true";
process.env.LANGSMITH_API_KEY = "...";
```
</CodeGroup>
:::

### é€‰æ‹© LLM

ä» LangChain çš„é›†æˆå¥—ä»¶ä¸­é€‰æ‹©ä¸€ä¸ªèŠå¤©æ¨¡å‹ï¼š

:::python
<ChatModelTabsPy />
:::

:::js
<ChatModelTabsJs />
:::

## 1. å®šä¹‰è‡ªå®šä¹‰çŠ¶æ€

é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰çŠ¶æ€æ¨¡å¼ï¼Œç”¨äºè·Ÿè¸ªå½“å‰å¤„äºå“ªä¸ªæ­¥éª¤ï¼š

```python
from langchain.agents import AgentState
from typing_extensions import NotRequired
from typing import Literal

# å®šä¹‰å¯èƒ½çš„å·¥ä½œæµæ­¥éª¤
SupportStep = Literal["warranty_collector", "issue_classifier", "resolution_specialist"]  # [!code highlight]

class SupportState(AgentState):  # [!code highlight]
    """å®¢æˆ·æ”¯æŒå·¥ä½œæµçš„çŠ¶æ€ã€‚"""
    current_step: NotRequired[SupportStep]  # [!code highlight]
    warranty_status: NotRequired[Literal["in_warranty", "out_of_warranty"]]
    issue_type: NotRequired[Literal["hardware", "software"]]
```

`current_step` å­—æ®µæ˜¯çŠ¶æ€æœºæ¨¡å¼çš„æ ¸å¿ƒâ€”â€”å®ƒå†³å®šäº†åœ¨æ¯ä¸€è½®ä¸­åŠ è½½å“ªä¸ªé…ç½®ï¼ˆæç¤ºè¯ + å·¥å…·ï¼‰ã€‚

## 2. åˆ›å»ºç®¡ç†å·¥ä½œæµçŠ¶æ€çš„å·¥å…·

åˆ›å»ºç”¨äºæ›´æ–°å·¥ä½œæµçŠ¶æ€çš„å·¥å…·ã€‚è¿™äº›å·¥å…·å…è®¸æ™ºèƒ½ä½“è®°å½•ä¿¡æ¯å¹¶è½¬æ¢åˆ°ä¸‹ä¸€æ­¥ã€‚

å…³é”®åœ¨äºä½¿ç”¨ `Command` æ¥æ›´æ–°çŠ¶æ€ï¼ŒåŒ…æ‹¬ `current_step` å­—æ®µï¼š

```python
from langchain.tools import tool, ToolRuntime
from langchain.messages import ToolMessage
from langgraph.types import Command

@tool
def record_warranty_status(
    status: Literal["in_warranty", "out_of_warranty"],
    runtime: ToolRuntime[None, SupportState],
) -> Command:  # [!code highlight]
    """è®°å½•å®¢æˆ·çš„ä¿ä¿®çŠ¶æ€å¹¶è½¬æ¢åˆ°é—®é¢˜åˆ†ç±»æ­¥éª¤ã€‚"""
    return Command(  # [!code highlight]
        update={  # [!code highlight]
            "messages": [
                ToolMessage(
                    content=f"Warranty status recorded as: {status}",
                    tool_call_id=runtime.tool_call_id,
                )
            ],
            "warranty_status": status,
            "current_step": "issue_classifier",  # [!code highlight]
        }
    )


@tool
def record_issue_type(
    issue_type: Literal["hardware", "software"],
    runtime: ToolRuntime[None, SupportState],
) -> Command:  # [!code highlight]
    """è®°å½•é—®é¢˜ç±»å‹å¹¶è½¬æ¢åˆ°è§£å†³æ–¹æ¡ˆä¸“å®¶æ­¥éª¤ã€‚"""
    return Command(  # [!code highlight]
        update={  # [!code highlight]
            "messages": [
                ToolMessage(
                    content=f"Issue type recorded as: {issue_type}",
                    tool_call_id=runtime.tool_call_id,
                )
            ],
            "issue_type": issue_type,
            "current_step": "resolution_specialist",  # [!code highlight]
        }
    )


@tool
def escalate_to_human(reason: str) -> str:
    """å°†æ¡ˆä¾‹å‡çº§ç»™äººå·¥æ”¯æŒä¸“å®¶ã€‚"""
    # åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œè¿™å°†åˆ›å»ºå·¥å•ã€é€šçŸ¥å·¥ä½œäººå‘˜ç­‰ã€‚
    return f"Escalating to human support. Reason: {reason}"


@tool
def provide_solution(solution: str) -> str:
    """ä¸ºå®¢æˆ·çš„é—®é¢˜æä¾›è§£å†³æ–¹æ¡ˆã€‚"""
    return f"Solution provided: {solution}"
```

æ³¨æ„ `record_warranty_status` å’Œ `record_issue_type` å¦‚ä½•è¿”å› `Command` å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡æ—¢æ›´æ–°æ•°æ®ï¼ˆ`warranty_status`ã€`issue_type`ï¼‰ä¹Ÿæ›´æ–° `current_step`ã€‚è¿™å°±æ˜¯çŠ¶æ€æœºçš„å·¥ä½œåŸç†â€”â€”å·¥å…·æ§åˆ¶å·¥ä½œæµçš„è¿›å±•ã€‚

## 3. å®šä¹‰æ­¥éª¤é…ç½®

ä¸ºæ¯ä¸ªæ­¥éª¤å®šä¹‰æç¤ºè¯å’Œå·¥å…·ã€‚é¦–å…ˆï¼Œä¸ºæ¯ä¸ªæ­¥éª¤å®šä¹‰æç¤ºè¯ï¼š

<Accordion title="æŸ¥çœ‹å®Œæ•´çš„æç¤ºè¯å®šä¹‰">

```python
# å°†æç¤ºè¯å®šä¹‰ä¸ºå¸¸é‡ä»¥ä¾¿å¼•ç”¨
WARRANTY_COLLECTOR_PROMPT = """You are a customer support agent helping with device issues.

CURRENT STAGE: Warranty verification

At this step, you need to:
1. Greet the customer warmly
2. Ask if their device is under warranty
3. Use record_warranty_status to record their response and move to the next step

Be conversational and friendly. Don't ask multiple questions at once."""

ISSUE_CLASSIFIER_PROMPT = """You are a customer support agent helping with device issues.

CURRENT STAGE: Issue classification
CUSTOMER INFO: Warranty status is {warranty_status}

At this step, you need to:
1. Ask the customer to describe their issue
2. Determine if it's a hardware issue (physical damage, broken parts) or software issue (app crashes, performance)
3. Use record_issue_type to record the classification and move to the next step

If unclear, ask clarifying questions before classifying."""

RESOLUTION_SPECIALIST_PROMPT = """You are a customer support agent helping with device issues.

CURRENT STAGE: Resolution
CUSTOMER INFO: Warranty status is {warranty_status}, issue type is {issue_type}

At this step, you need to:
1. For SOFTWARE issues: provide troubleshooting steps using provide_solution
2. For HARDWARE issues:
   - If IN WARRANTY: explain warranty repair process using provide_solution
   - If OUT OF WARRANTY: escalate_to_human for paid repair options

Be specific and helpful in your solutions."""
```

</Accordion>

ç„¶åä½¿ç”¨å­—å…¸å°†æ­¥éª¤åç§°æ˜ å°„åˆ°å…¶é…ç½®ï¼š

```python
# æ­¥éª¤é…ç½®ï¼šå°†æ­¥éª¤åç§°æ˜ å°„åˆ°ï¼ˆæç¤ºè¯ï¼Œå·¥å…·ï¼Œæ‰€éœ€çŠ¶æ€ï¼‰
STEP_CONFIG = {
    "warranty_collector": {
        "prompt": WARRANTY_COLLECTOR_PROMPT,
        "tools": [record_warranty_status],
        "requires": [],
    },
    "issue_classifier": {
        "prompt": ISSUE_CLASSIFIER_PROMPT,
        "tools": [record_issue_type],
        "requires": ["warranty_status"],
    },
    "resolution_specialist": {
        "prompt": RESOLUTION_SPECIALIST_PROMPT,
        "tools": [provide_solution, escalate_to_human],
        "requires": ["warranty_status", "issue_type"],
    },
}
```

è¿™ç§åŸºäºå­—å…¸çš„é…ç½®ä½¿å¾—ï¼š
- ä¸€ç›®äº†ç„¶åœ°æŸ¥çœ‹æ‰€æœ‰æ­¥éª¤
- æ·»åŠ æ–°æ­¥éª¤ï¼ˆåªéœ€æ·»åŠ å¦ä¸€ä¸ªæ¡ç›®ï¼‰
- ç†è§£å·¥ä½œæµä¾èµ–å…³ç³»ï¼ˆ`requires` å­—æ®µï¼‰
- ä½¿ç”¨å¸¦æœ‰çŠ¶æ€å˜é‡çš„æç¤ºè¯æ¨¡æ¿ï¼ˆä¾‹å¦‚ `{warranty_status}`ï¼‰

## 4. åˆ›å»ºåŸºäºæ­¥éª¤çš„ä¸­é—´ä»¶

åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶ï¼Œä»çŠ¶æ€ä¸­è¯»å– `current_step` å¹¶åº”ç”¨ç›¸åº”çš„é…ç½®ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ `@wrap_model_call` è£…é¥°å™¨æ¥å®ç°ä¸€ä¸ªæ¸…æ™°çš„å®ç°ï¼š

```python
from langchain.agents.middleware import wrap_model_call, ModelRequest, ModelResponse
from typing import Callable


@wrap_model_call  # [!code highlight]
def apply_step_config(
    request: ModelRequest,
    handler: Callable[[ModelRequest], ModelResponse],
) -> ModelResponse:
    """æ ¹æ®å½“å‰æ­¥éª¤é…ç½®æ™ºèƒ½ä½“è¡Œä¸ºã€‚"""
    # è·å–å½“å‰æ­¥éª¤ï¼ˆé¦–æ¬¡äº¤äº’é»˜è®¤ä¸º warranty_collectorï¼‰
    current_step = request.state.get("current_step", "warranty_collector")  # [!code highlight]

    # æŸ¥æ‰¾æ­¥éª¤é…ç½®
    stage_config = STEP_CONFIG[current_step]  # [!code highlight]

    # éªŒè¯æ‰€éœ€çŠ¶æ€æ˜¯å¦å­˜åœ¨
    for key in stage_config["requires"]:
        if request.state.get(key) is None:
            raise ValueError(f"{key} must be set before reaching {current_step}")

    # ä½¿ç”¨çŠ¶æ€å€¼æ ¼å¼åŒ–æç¤ºè¯ï¼ˆæ”¯æŒ {warranty_status}ã€{issue_type} ç­‰ï¼‰
    system_prompt = stage_config["prompt"].format(**request.state)

    # æ³¨å…¥ç³»ç»Ÿæç¤ºè¯å’Œæ­¥éª¤ç‰¹å®šå·¥å…·
    request = request.override(  # [!code highlight]
        system_prompt=system_prompt,  # [!code highlight]
        tools=stage_config["tools"],  # [!code highlight]
    )

    return handler(request)
```

è¿™ä¸ªä¸­é—´ä»¶ï¼š

1.  **è¯»å–å½“å‰æ­¥éª¤**ï¼šä»çŠ¶æ€ä¸­è·å– `current_step`ï¼ˆé»˜è®¤ä¸º "warranty_collector"ï¼‰ã€‚
2.  **æŸ¥æ‰¾é…ç½®**ï¼šåœ¨ `STEP_CONFIG` ä¸­æ‰¾åˆ°åŒ¹é…çš„æ¡ç›®ã€‚
3.  **éªŒè¯ä¾èµ–å…³ç³»**ï¼šç¡®ä¿æ‰€éœ€çš„çŠ¶æ€å­—æ®µå­˜åœ¨ã€‚
4.  **æ ¼å¼åŒ–æç¤ºè¯**ï¼šå°†çŠ¶æ€å€¼æ³¨å…¥åˆ°æç¤ºè¯æ¨¡æ¿ä¸­ã€‚
5.  **åº”ç”¨é…ç½®**ï¼šè¦†ç›–ç³»ç»Ÿæç¤ºè¯å’Œå¯ç”¨å·¥å…·ã€‚

`request.override()` æ–¹æ³•æ˜¯å…³é”®â€”â€”å®ƒå…è®¸æˆ‘ä»¬æ ¹æ®çŠ¶æ€åŠ¨æ€æ›´æ”¹æ™ºèƒ½ä½“çš„è¡Œä¸ºï¼Œè€Œæ— éœ€åˆ›å»ºå•ç‹¬çš„æ™ºèƒ½ä½“å®ä¾‹ã€‚

## 5. åˆ›å»ºæ™ºèƒ½ä½“

ç°åœ¨ä½¿ç”¨åŸºäºæ­¥éª¤çš„ä¸­é—´ä»¶å’Œä¸€ä¸ªç”¨äºçŠ¶æ€æŒä¹…åŒ–çš„æ£€æŸ¥ç‚¹å™¨æ¥åˆ›å»ºæ™ºèƒ½ä½“ï¼š

```python
from langchain.agents import create_agent
from langgraph.checkpoint.memory import InMemorySaver

# ä»æ‰€æœ‰æ­¥éª¤é…ç½®ä¸­æ”¶é›†æ‰€æœ‰å·¥å…·
all_tools = [
    record_warranty_status,
    record_issue_type,
    provide_solution,
    escalate_to_human,
]

# ä½¿ç”¨åŸºäºæ­¥éª¤çš„é…ç½®åˆ›å»ºæ™ºèƒ½ä½“
agent = create_agent(
    model,
    tools=all_tools,
    state_schema=SupportState,  # [!code highlight]
    middleware=[apply_step_config],  # [!code highlight]
    checkpointer=InMemorySaver(),  # [!code highlight]
)
```

<Note>
**ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ç‚¹å™¨ï¼Ÿ** æ£€æŸ¥ç‚¹å™¨åœ¨å¯¹è¯è½®æ¬¡ä¹‹é—´ç»´æŠ¤çŠ¶æ€ã€‚æ²¡æœ‰å®ƒï¼Œ`current_step` çŠ¶æ€å°†åœ¨ç”¨æˆ·æ¶ˆæ¯ä¹‹é—´ä¸¢å¤±ï¼Œä»è€Œç ´åå·¥ä½œæµã€‚
</Note>

## 6. æµ‹è¯•å·¥ä½œæµ

æµ‹è¯•å®Œæ•´çš„å·¥ä½œæµï¼š

```python
from langchain.messages import HumanMessage
import uuid

# æ­¤å¯¹è¯çº¿ç¨‹çš„é…ç½®
thread_id = str(uuid.uuid4())
config = {"configurable": {"thread_id": thread_id}}

# ç¬¬ 1 è½®ï¼šåˆå§‹æ¶ˆæ¯ - ä» warranty_collector æ­¥éª¤å¼€å§‹
print("=== Turn 1: Warranty Collection ===")
result = agent.invoke(
    {"messages": [HumanMessage("Hi, my phone screen is cracked")]},
    config
)
for msg in result['messages']:
    msg.pretty_print()

# ç¬¬ 2 è½®ï¼šç”¨æˆ·å›åº”ä¿ä¿®æƒ…å†µ
print("\n=== Turn 2: Warranty Response ===")
result = agent.invoke(
    {"messages": [HumanMessage("Yes, it's still under warranty")]},
    config
)
for msg in result['messages']:
    msg.pretty_print()
print(f"Current step: {result.get('current_step')}")

# ç¬¬ 3 è½®ï¼šç”¨æˆ·æè¿°é—®é¢˜
print("\n=== Turn 3: Issue Description ===")
result = agent.invoke(
    {"messages": [HumanMessage("The screen is physically cracked from dropping it")]},
    config
)
for msg in result['messages']:
    msg.pretty_print()
print(f"Current step: {result.get('current_step')}")

# ç¬¬ 4 è½®ï¼šè§£å†³æ–¹æ¡ˆ
print("\n=== Turn 4: Resolution ===")
result = agent.invoke(
    {"messages": [HumanMessage("What should I do?")]},
    config
)
for msg in result['messages']:
    msg.pretty_print()
```

é¢„æœŸæµç¨‹ï¼š
1.  **ä¿ä¿®éªŒè¯æ­¥éª¤**ï¼šè¯¢é—®ä¿ä¿®çŠ¶æ€
2.  **é—®é¢˜åˆ†ç±»æ­¥éª¤**ï¼šè¯¢é—®é—®é¢˜ï¼Œç¡®å®šä¸ºç¡¬ä»¶é—®é¢˜
3.  **è§£å†³æ–¹æ¡ˆæ­¥éª¤**ï¼šæä¾›ä¿ä¿®ç»´ä¿®è¯´æ˜

## 7. ç†è§£çŠ¶æ€è½¬æ¢

è®©æˆ‘ä»¬è¿½è¸ªæ¯ä¸€è½®å‘ç”Ÿäº†ä»€ä¹ˆï¼š

### ç¬¬ 1 è½®ï¼šåˆå§‹æ¶ˆæ¯
```python
{
    "messages": [HumanMessage("Hi, my phone screen is cracked")],
    "current_step": "warranty_collector"  # é»˜è®¤å€¼
}
```

ä¸­é—´ä»¶åº”ç”¨ï¼š
- ç³»ç»Ÿæç¤ºè¯ï¼š`WARRANTY_COLLECTOR_PROMPT`
- å·¥å…·ï¼š`[record_warranty_status]`

### ç¬¬ 2 è½®ï¼šä¿ä¿®è®°å½•å
å·¥å…·è°ƒç”¨ï¼š`record_warranty_status("in_warranty")` è¿”å›ï¼š
```python
Command(update={
    "warranty_status": "in_warranty",
    "current_step": "issue_classifier"  # çŠ¶æ€è½¬æ¢ï¼
})
```

ä¸‹ä¸€è½®ï¼Œä¸­é—´ä»¶åº”ç”¨ï¼š
- ç³»ç»Ÿæç¤ºè¯ï¼š`ISSUE_CLASSIFIER_PROMPT`ï¼ˆä½¿ç”¨ `warranty_status="in_warranty"` æ ¼å¼åŒ–ï¼‰
- å·¥å…·ï¼š`[record_issue_type]`

### ç¬¬ 3 è½®ï¼šé—®é¢˜åˆ†ç±»å
å·¥å…·è°ƒç”¨ï¼š`record_issue_type("hardware")` è¿”å›ï¼š
```python
Command(update={
    "issue_type": "hardware",
    "current_step": "resolution_specialist"  # çŠ¶æ€è½¬æ¢ï¼
})
```

ä¸‹ä¸€è½®ï¼Œä¸­é—´ä»¶åº”ç”¨ï¼š
- ç³»ç»Ÿæç¤ºè¯ï¼š`RESOLUTION_SPECIALIST_PROMPT`ï¼ˆä½¿ç”¨ `warranty_status` å’Œ `issue_type` æ ¼å¼åŒ–ï¼‰
- å·¥å…·ï¼š`[provide_solution, escalate_to_human]`

å…³é”®è§è§£ï¼š**å·¥å…·é€šè¿‡æ›´æ–° `current_step` æ¥é©±åŠ¨å·¥ä½œæµ**ï¼Œè€Œ**ä¸­é—´ä»¶é€šè¿‡åœ¨ä¸‹è½®åº”ç”¨é€‚å½“çš„é…ç½®æ¥å“åº”**ã€‚

## 8. ç®¡ç†æ¶ˆæ¯å†å²è®°å½•

éšç€æ™ºèƒ½ä½“åœ¨æ­¥éª¤ä¸­å‰è¿›ï¼Œæ¶ˆæ¯å†å²è®°å½•ä¼šå¢é•¿ã€‚ä½¿ç”¨[æ‘˜è¦ä¸­é—´ä»¶](/oss/langchain/short-term-memory#summarize-messages)æ¥å‹ç¼©è¾ƒæ—©çš„æ¶ˆæ¯ï¼ŒåŒæ—¶ä¿ç•™å¯¹è¯ä¸Šä¸‹æ–‡ï¼š

```python
from langchain.agents import create_agent
from langchain.agents.middleware import SummarizationMiddleware  # [!code highlight]
from langgraph.checkpoint.memory import InMemorySaver

agent = create_agent(
    model,
    tools=all_tools,
    state_schema=SupportState,
    middleware=[
        apply_step_config,
        SummarizationMiddleware(  # [!code highlight]
            model="gpt-4o-mini",
            trigger=("tokens", 4000),
            keep=("messages", 10)
        )
    ],
    checkpointer=InMemorySaver(),
)
```

æœ‰å…³å…¶ä»–å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œè¯·å‚é˜…[çŸ­æœŸè®°å¿†æŒ‡å—
