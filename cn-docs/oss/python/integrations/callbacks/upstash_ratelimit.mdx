---
title: Upstash Ratelimit 回调
---
在本指南中，我们将介绍如何使用 `UpstashRatelimitHandler` 来添加基于请求数量或令牌数量的速率限制。该处理器使用了 [Upstash 的 ratelimit 库](https://github.com/upstash/ratelimit-py/)，该库利用了 [Upstash Redis](https://upstash.com/docs/redis/overall/getstarted)。

Upstash Ratelimit 的工作原理是，每次调用 `limit` 方法时，都会向 Upstash Redis 发送一个 HTTP 请求。系统会检查并更新用户的剩余令牌/请求数量。根据剩余的令牌数量，我们可以停止执行成本高昂的操作，例如调用 LLM 或查询向量存储：

```py
response = ratelimit.limit()
if response.allowed:
    execute_costly_operation()
```

`UpstashRatelimitHandler` 允许您在几分钟内将速率限制逻辑集成到您的链中。

首先，您需要前往 [Upstash 控制台](https://console.upstash.com/login) 并创建一个 Redis 数据库（[请参阅我们的文档](https://upstash.com/docs/redis/overall/getstarted)）。创建数据库后，您需要设置环境变量：

```
UPSTASH_REDIS_REST_URL="****"
UPSTASH_REDIS_REST_TOKEN="****"
```

接下来，您需要安装 Upstash Ratelimit 和 Redis 库：

```
pip install upstash-ratelimit upstash-redis
```

现在，您已准备好为您的链添加速率限制了！

## 基于请求的速率限制

假设我们希望允许用户每分钟调用我们的链 10 次。实现这一点非常简单：

```python
# 设置环境变量
import os

os.environ["UPSTASH_REDIS_REST_URL"] = "****"
os.environ["UPSTASH_REDIS_REST_TOKEN"] = "****"

from langchain_community.callbacks import UpstashRatelimitError, UpstashRatelimitHandler
from langchain_core.runnables import RunnableLambda
from upstash_ratelimit import FixedWindow, Ratelimit
from upstash_redis import Redis

# 创建 ratelimit
ratelimit = Ratelimit(
    redis=Redis.from_env(),
    # 每个窗口 10 个请求，窗口大小为 60 秒：
    limiter=FixedWindow(max_requests=10, window=60),
)

# 创建处理器
user_id = "user_id"  # 应该是一个获取用户 ID 的方法
handler = UpstashRatelimitHandler(identifier=user_id, request_ratelimit=ratelimit)

# 创建模拟链
chain = RunnableLambda(str)

# 使用处理器调用链：
try:
    result = chain.invoke("Hello world!", config={"callbacks": [handler]})
except UpstashRatelimitError:
    print("Handling ratelimit.", UpstashRatelimitError)
```

```text
Error in UpstashRatelimitHandler.on_chain_start callback: UpstashRatelimitError('Request limit reached!')
```
```text
Handling ratelimit. <class 'langchain_community.callbacks.upstash_ratelimit_callback.UpstashRatelimitError'>
```

请注意，我们将处理器传递给 `invoke` 方法，而不是在定义链时传递处理器。

对于 `FixedWindow` 以外的速率限制算法，请参阅 [upstash-ratelimit 文档](https://github.com/upstash/ratelimit-py?tab=readme-ov-file#ratelimiting-algorithms)。

在执行我们管道中的任何步骤之前，ratelimit 将检查用户是否已超过请求限制。如果是，则会引发 `UpstashRatelimitError`。

## 基于令牌的速率限制

另一种选择是基于以下内容对链调用进行速率限制：

1.  提示中的令牌数量
2.  提示和 LLM 完成中的令牌数量

这仅在您的链中包含 LLM 时才有效。另一个要求是您使用的 LLM 应在其 `LLMOutput` 中返回令牌使用情况。

### 工作原理

处理器将在调用 LLM 之前获取剩余令牌。如果剩余令牌大于 0，则将调用 LLM。否则将引发 `UpstashRatelimitError`。

调用 LLM 后，令牌使用信息将用于从用户的剩余令牌中扣除。在此阶段不会引发错误。

### 配置

对于第一种配置，只需像这样初始化处理器：

```python
ratelimit = Ratelimit(
        redis=Redis.from_env(),
    # 每个窗口 1000 个令牌，窗口大小为 60 秒：
        limiter=FixedWindow(max_requests=1000, window=60),
)

handler = UpstashRatelimitHandler(identifier=user_id, token_ratelimit=ratelimit)
```

对于第二种配置，以下是初始化处理器的方法：

```python
ratelimit = Ratelimit(
        redis=Redis.from_env(),
    # 每个窗口 1000 个令牌，窗口大小为 60 秒：
        limiter=FixedWindow(max_requests=1000, window=60),
)

handler = UpstashRatelimitHandler(
        identifier=user_id,
        token_ratelimit=ratelimit,
        include_output_tokens=True,  # 设置为 True
)
```

您还可以同时基于请求和令牌实施速率限制，只需同时传递 `request_ratelimit` 和 `token_ratelimit` 参数即可。

以下是一个使用 LLM 的链的示例：

```python
# 设置环境变量
import os

os.environ["UPSTASH_REDIS_REST_URL"] = "****"
os.environ["UPSTASH_REDIS_REST_TOKEN"] = "****"
os.environ["OPENAI_API_KEY"] = "****"

from langchain_community.callbacks import UpstashRatelimitError, UpstashRatelimitHandler
from langchain_core.runnables import RunnableLambda
from langchain_openai import ChatOpenAI
from upstash_ratelimit import FixedWindow, Ratelimit
from upstash_redis import Redis

# 创建 ratelimit
ratelimit = Ratelimit(
        redis=Redis.from_env(),
    # 每个窗口 500 个令牌，窗口大小为 60 秒：
        limiter=FixedWindow(max_requests=500, window=60),
)

# 创建处理器
user_id = "user_id"  # 应该是一个获取用户 ID 的方法
handler = UpstashRatelimitHandler(identifier=user_id, token_ratelimit=ratelimit)

# 创建模拟链
as_str = RunnableLambda(str)
model = ChatOpenAI()

chain = as_str | model

# 使用处理器调用链：
try:
        result = chain.invoke("Hello world!", config={"callbacks": [handler]})
except UpstashRatelimitError:
    print("Handling ratelimit.", UpstashRatelimitError)
```

```text
Error in UpstashRatelimitHandler.on_llm_start callback: UpstashRatelimitError('Token limit reached!')
```
```text
Handling ratelimit. <class 'langchain_community.callbacks.upstash_ratelimit_callback.UpstashRatelimitError'>
```
