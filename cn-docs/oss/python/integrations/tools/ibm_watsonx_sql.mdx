---
title: IBM watsonx.ai
---
æœ¬ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `langchain-ibm` çš„ `watsonx.ai` SQL æ•°æ®åº“å·¥å…·åŒ…ï¼Œè¯¥å·¥å…·åŒ…ä½¿ç”¨ Flight æœåŠ¡ã€‚

<Warning>
æ„å»º SQL æ•°æ®åº“çš„é—®ç­”ç³»ç»Ÿéœ€è¦æ‰§è¡Œæ¨¡å‹ç”Ÿæˆçš„ SQL æŸ¥è¯¢ï¼Œè¿™å­˜åœ¨å›ºæœ‰çš„å®‰å…¨é£é™©ã€‚è¯·ç¡®ä¿æ‚¨çš„æ•°æ®åº“è¿æ¥æƒé™å§‹ç»ˆæ ¹æ®ä»£ç†çš„éœ€æ±‚å°½å¯èƒ½ç¼©å°èŒƒå›´ã€‚è¿™å°†å‡è½»ï¼ˆå°½ç®¡ä¸èƒ½æ¶ˆé™¤ï¼‰æ„å»ºæ¨¡å‹é©±åŠ¨ç³»ç»Ÿçš„é£é™©ã€‚
</Warning>

## æ¦‚è¿°

### é›†æˆè¯¦æƒ…

| ç±» | åŒ… | å¯åºåˆ—åŒ– | [JS æ”¯æŒ](https://js.langchain.com/docs/integrations/toolkits/ibm/) | ä¸‹è½½é‡ | ç‰ˆæœ¬ |
| :--- | :--- | :---: | :---: | :---: | :---: |
| [`WatsonxSQLDatabaseToolkit`](https://reference.langchain.com/python/integrations/langchain_ibm/WatsonxToolkit/) | [`langchain-ibm`](https://reference.langchain.com/python/integrations/langchain_ibm/) | âŒ | âŒ | ![PyPI - Downloads](https://img.shields.io/pypi/dm/langchain-ibm?style=flat-square&label=%20) | ![PyPI - Version](https://img.shields.io/pypi/v/langchain-ibm?style=flat-square&label=%20) |

## è®¾ç½®

è¦è®¿é—® `langchain-ibm` SQL æ•°æ®åº“å·¥å…·åŒ…ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ª IBM watsonx.ai è´¦æˆ·ï¼Œè·å– API å¯†é’¥ï¼Œå¹¶å®‰è£… `langchain-ibm` é›†æˆåŒ…ã€‚

### å‡­è¯

æ­¤å•å…ƒæ ¼å®šä¹‰äº†ä½¿ç”¨ watsonx SQL æ•°æ®åº“å·¥å…·åŒ…æ‰€éœ€çš„ WML å‡­è¯ã€‚

**æ“ä½œï¼š** æä¾› IBM Cloud ç”¨æˆ· API å¯†é’¥ã€‚è¯¦æƒ…è¯·å‚é˜…[æ–‡æ¡£](https://cloud.ibm.com/docs/account?topic=account-userapikey&interface=ui)ã€‚

```python
import os
from getpass import getpass

watsonx_api_key = getpass()
os.environ["WATSONX_APIKEY"] = watsonx_api_key
```

æ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥å°†å…¶ä»–å¯†é’¥ä½œä¸ºç¯å¢ƒå˜é‡ä¼ é€’ã€‚

```python
import os

os.environ["WATSONX_URL"] = "your service instance url"
os.environ["WATSONX_TOKEN"] = "your token for accessing the CLOUD or CPD cluster"
os.environ["WATSONX_PASSWORD"] = "your password for accessing the CPD cluster"
os.environ["WATSONX_USERNAME"] = "your username for accessing the CPD cluster"
os.environ["WATSONX_INSTANCE_ID"] = "your instance_id for accessing the CPD cluster"
```

### å®‰è£…

LangChain IBM é›†æˆä½äº `langchain-ibm` åŒ…ä¸­ï¼š

```python
pip install -qU "langchain-ibm[sql-toolkit]"
```

## å®ä¾‹åŒ–

è¦è®¾ç½® SQL æ•°æ®åº“å·¥å…·åŒ…ï¼Œæ‚¨å¿…é¡»é¦–å…ˆå®ä¾‹åŒ– `WatsonxSQLDatabase` ç±»ï¼Œè¯¥ç±»é€šè¿‡ Flight SQL å®¢æˆ·ç«¯ä» IBM watsonx.ai æ•°æ®åº“è¿æ¥èµ„äº§ä¸­æ£€ç´¢å¿…è¦ä¿¡æ¯ã€‚æœ‰å…³ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»ºæ•°æ®åº“è¿æ¥èµ„äº§çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… watsonx.ai Python SDK [æ–‡æ¡£](https://ibm.github.io/watsonx-ai-python-sdk/v1.4.7/autoai_working_with_dataconnection.html#connection-asset-databaselocation)ã€‚

```python
from langchain_ibm.utilities.sql_database import WatsonxSQLDatabase

wx_sql_database = WatsonxSQLDatabase(
    connection_id=postgres_sql_connection_id,
    url="https://us-south.ml.cloud.ibm.com",
    schema="public"
    )
```

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Cloud Pak for Data å‡­è¯ã€‚è¯¦æƒ…è¯·å‚é˜… [watsonx.ai è½¯ä»¶è®¾ç½®](https://ibm.github.io/watsonx-ai-python-sdk/setup_cpd.html)ã€‚

å¯¹äºæŸäº›éœ€æ±‚ï¼Œå¯ä»¥é€‰æ‹©å°† IBM çš„ [`APIClient`](https://ibm.github.io/watsonx-ai-python-sdk/base.html#apiclient) å¯¹è±¡ä¼ é€’ç»™ `WatsonxSQLDatabase` ç±»ã€‚

```python
from ibm_watsonx_ai import APIClient

api_client = APIClient(...)

wx_sql_database = WatsonxSQLDatabse(
    watsonx_client=api_client,
    connection_id=postgres_sql_connection_id,
    schema="public"
)
```

æœ€åï¼Œåˆå§‹åŒ– `WatsonxSQLDatabaseToolkit`ã€‚

```python
from langchain_ibm import ChatWatsonx

llm = ChatWatsonx(...)

from langchain_ibm.agent_toolkits.sql import WatsonxSQLDatabaseToolkit

wx_sql_toolkit = WatsonxSQLDatabaseToolkit(
    db=wx_sql_database,
    llm=llm,
)
```

## å·¥å…·

### è·å–æ‰€æœ‰å·¥å…·

è¿è¡Œ `.get_tools` æ–¹æ³•ï¼Œå¯ä»¥è·å–æ‰€æœ‰å¯ç”¨å·¥å…·çš„åˆ—è¡¨ã€‚

```python
wx_sql_toolkit.get_tools()
```

```text
[QuerySQLDatabaseTool(description="Input to this tool is a detailed and correct SQL query, output is a result from the database. If the query is not correct, an error message will be returned. If an error is returned, rewrite the query, check the query, and try again. If you encounter an issue with Unknown column 'xxxx' in 'field list', use sql_db_schema to query the correct table fields.", db=<langchain_ibm.utilities.sql_database.WatsonxSQLDatabase object at 0x111c03810>),
 InfoSQLDatabaseTool(description='Input to this tool is a comma-separated list of tables, output is the SQL statement with table metadata. Be sure that the tables actually exist by calling sql_db_list_tables first! Example Input: table1, table2, table3', db=<langchain_ibm.utilities.sql_database.WatsonxSQLDatabase object at 0x111c03810>),
 ListSQLDatabaseTool(db=<langchain_ibm.utilities.sql_database.WatsonxSQLDatabase object at 0x111c03810>),
 QuerySQLCheckerTool(description='Use this tool to double check if your query is correct before executing it. Always use this tool before executing a query with sql_db_query!', db=<langchain_ibm.utilities.sql_database.WatsonxSQLDatabase object at 0x111c03810>, llm=ChatWatsonx(model_id='ibm/granite-3-3-8b-instruct', apikey=SecretStr('**********'), params={}, watsonx_model=<ibm_watsonx_ai.foundation_models.inference.model_inference.ModelInference object at 0x12aa12ed0>, watsonx_client=<ibm_watsonx_ai.client.APIClient object at 0x12aa12ad0>), llm_chain=PromptTemplate(input_variables=['query', 'schema'], input_types={}, partial_variables={}, template='\n{query}\nDouble check the query above for common mistakes, including:\n- Using NOT IN with NULL values\n- Using UNION when UNION ALL should have been used\n- Using BETWEEN for exclusive ranges\n- Data type mismatch in predicates\n- Properly quoting identifiers\n- Using the correct number of arguments for functions\n- Casting to the correct data type\n- Using the proper columns for joins\n- Make sure that schema name `{schema}` is added to the table name, e.g. {schema}.table1\n\nIf there are any of the above mistakes, rewrite the query. If there are no mistakes, just reproduce the original query.\n\nOutput the final SQL query only.\n\nSQL Query: ')
 | ChatWatsonx(model_id='ibm/granite-3-3-8b-instruct', apikey=SecretStr('**********'), params={}, watsonx_model=<ibm_watsonx_ai.foundation_models.inference.model_inference.ModelInference object at 0x12aa12ed0>, watsonx_client=<ibm_watsonx_ai.client.APIClient object at 0x12aa12ad0>))]
```

æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨å„ä¸ªå·¥å…·ï¼š

```python
from langchain_ibm.agent_toolkits.sql.tool import (
    InfoSQLDatabaseTool,
    ListSQLDatabaseTool,
    QuerySQLDatabaseTool,
    QuerySQLCheckerTool
)
```

## åœ¨ä»£ç†ä¸­ä½¿ç”¨

```python
from langchain_ibm import ChatWatsonx

llm = ChatWatsonx(
    model_id="meta-llama/llama-3-3-70b-instruct",
    url="https://us-south.ml.cloud.ibm.com",
    project_id="PASTE YOUR PROJECT_ID HERE",
)
```

```python
from langgraph.prebuilt import create_react_agent

# ä½¿ç”¨ langchain hub ä¸­çš„ä¸€ä¸ªæç¤ºè¯
from langchain import hub

prompt_template = hub.pull("langchain-ai/sql-agent-system-prompt")
system_message = prompt_template.format(dialect="PostgreSQL", top_k=5)

agent_executor = create_react_agent(llm, wx_sql_toolkit.get_tools(), prompt=system_message, debug=True)
```

```python
example_query = "What city has the highest population?"

events = agent.stream(
    {"messages": [("user", example_query)]},
    stream_mode="values",
)
for event in events:
    event["messages"][-1].pretty_print()
```

```text
================================[1m Human Message [0m=================================

What city has the largest population?
==================================[1m Ai Message [0m==================================
Tool Calls:
  sql_db_query (chatcmpl-tool-336c8be3bce64f44a7977c3053f36922)
 Call ID: chatcmpl-tool-336c8be3bce64f44a7977c3053f36922
  Args:
    query: SELECT city FROM cities ORDER BY population DESC LIMIT 1
=================================[1m Tool Message [0m=================================
Name: sql_db_query

Error: Flight returned internal error, with message: CDICO2021E: Statement could not be processed: SQL syntax error: [IBM][PostgreSQL JDBC Driver][PostgreSQL]column "city" does not exist. . The statement text is: SELECT city FROM cities ORDER BY population DESC LIMIT 1
==================================[1m Ai Message [0m==================================
Tool Calls:
  sql_db_schema (chatcmpl-tool-2dc38420280c4960b13b0e5533634fd3)
 Call ID: chatcmpl-tool-2dc38420280c4960b13b0e5533634fd3
  Args:
    table_names: cities
=================================[1m Tool Message [0m=================================
Name: sql_db_schema


CREATE TABLE "public"."cities" (
	"id" INTEGER NOT NULL,
	"name" CHARACTER VARYING,
	"population" INTEGER,
	CONSTRAINT primary_key PRIMARY KEY (id)
	)

First 3 rows of table cities:

 id   name  population
  1 Warsaw     1790658
  2 KrakÃ³w      803425
  3   ÅÃ³dÅº      658444
==================================[1m Ai Message [0m==================================
Tool Calls:
  sql_db_query_checker (chatcmpl-tool-1ecbb02ce7ac47e186edbfff144eacdc)
 Call ID: chatcmpl-tool-1ecbb02ce7ac47e186edbfff144eacdc
  Args:
    query: SELECT name FROM cities ORDER BY population DESC LIMIT 1
=================================[1m Tool Message [0m=================================
Name: sql_db_query_checker

<p>The given query</p><div><div><div>SELECT name FROM cities ORDER BY population DESC LIMIT 1</div></div></div><p>appears to be syntactically correct but lacks schema specification if the table 'cities' is not in the default 'public' schema. Assuming it's under 'public', here's the complete query with schema specification:</p><div><div><div>SELECT name FROM public.cities ORDER BY population DESC LIMIT 1</div></div></div>
==================================[1m Ai Message [0m==================================
Tool Calls:
  sql_db_query (chatcmpl-tool-d8e0eff8b07b40f593dc1b97e6280598)
 Call ID: chatcmpl-tool-d8e0eff8b07b40f593dc1b97e6280598
  Args:
    query: SELECT name FROM public.cities ORDER BY population DESC LIMIT 1
=================================[1m Tool Message [0m=================================
Name: sql_db_query

[('Warsaw',)]
==================================[1m Ai Message [0m==================================

The city with the largest population is Warsaw.
```

---

## API å‚è€ƒ

æœ‰å…³ `WatsonxSQLDatabaseToolkit` æ‰€æœ‰åŠŸèƒ½å’Œé…ç½®çš„è¯¦ç»†æ–‡æ¡£ï¼Œè¯·å‰å¾€ [API å‚è€ƒ](https://reference.langchain.com/python/integrations/langchain_ibm/WatsonxSQLDatabaseToolkit/)ã€‚
