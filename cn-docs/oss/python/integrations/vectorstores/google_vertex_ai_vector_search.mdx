---
title: Google Vertex AI 向量搜索
---
本笔记本展示了如何使用与 `Google Cloud Vertex AI Vector Search` 向量数据库相关的功能。

> [Google Vertex AI Vector Search](https://cloud.google.com/vertex-ai/docs/vector-search/overview)，前身为 Vertex AI Matching Engine，提供业界领先的大规模低延迟向量数据库。这些向量数据库通常被称为向量相似性匹配或近似最近邻（ANN）服务。

**注意**：LangChain API 期望端点（endpoint）和已部署的索引（index）已经创建。索引创建时间可能长达一小时。

> 要了解如何创建索引，请参阅章节 [创建索引并将其部署到端点](#创建索引并将其部署到端点)
如果您已有已部署的索引，请跳转到 [从文本创建向量存储](#从文本创建向量存储)

## 创建索引并将其部署到端点

- 本节演示如何创建新索引并将其部署到端点

```python
# TODO : 根据您的需求设置值
# 项目和存储常量
PROJECT_ID = "<my_project_id>"
REGION = "<my_region>"
BUCKET = "<my_gcs_bucket>"
BUCKET_URI = f"gs://{BUCKET}"

# textembedding-gecko@003 的维度数为 768
# 如果使用其他嵌入器，维度可能需要更改。
DIMENSIONS = 768

# 索引常量
DISPLAY_NAME = "<my_matching_engine_index_id>"
DEPLOYED_INDEX_ID = "<my_matching_engine_endpoint_id>"
```

```python
# 创建一个存储桶。
! gsutil mb -l $REGION -p $PROJECT_ID $BUCKET_URI
```

### 使用 `VertexAIEmbeddings` 作为嵌入模型

```python
from google.cloud import aiplatform
from langchain_google_vertexai import VertexAIEmbeddings
```

```python
aiplatform.init(project=PROJECT_ID, location=REGION, staging_bucket=BUCKET_URI)
```

```python
embedding_model = VertexAIEmbeddings(model_name="text-embedding-005")
```

### 创建空索引

**注意：** 创建索引时，您应指定 "index_update_method"，可以是 "BATCH_UPDATE" 或 "STREAM_UPDATE"
> 批处理索引适用于您希望批量更新索引的情况，数据是在一段时间内存储的，例如每周或每月处理的系统。流式索引适用于您希望索引数据在数据存储中添加新数据时立即更新的情况，例如，如果您有一个书店并希望尽快在线显示新库存。您选择的类型很重要，因为设置和要求不同。

有关配置索引的更多详细信息，请参阅 [官方文档](https://cloud.google.com/vertex-ai/docs/vector-search/create-manage-index#create-index-batch)

```python
# 注意：此操作可能需要长达 30 秒
my_index = aiplatform.MatchingEngineIndex.create_tree_ah_index(
    display_name=DISPLAY_NAME,
    dimensions=DIMENSIONS,
    approximate_neighbors_count=150,
    distance_measure_type="DOT_PRODUCT_DISTANCE",
    index_update_method="STREAM_UPDATE",  # 允许的值 BATCH_UPDATE , STREAM_UPDATE
)
```

### 创建端点

```python
# 创建一个端点
my_index_endpoint = aiplatform.MatchingEngineIndexEndpoint.create(
    display_name=f"{DISPLAY_NAME}-endpoint", public_endpoint_enabled=True
)
```

### 将索引部署到端点

```python
# 注意：此操作可能需要长达 20 分钟
my_index_endpoint = my_index_endpoint.deploy_index(
    index=my_index, deployed_index_id=DEPLOYED_INDEX_ID
)

my_index_endpoint.deployed_indexes
```

## 从文本创建向量存储

注意：如果您已有现有索引和端点，可以使用以下代码加载它们

```python
# TODO : 将 1234567890123456789 替换为您的实际索引 ID
my_index = aiplatform.MatchingEngineIndex("1234567890123456789")

# TODO : 将 1234567890123456789 替换为您的实际端点 ID
my_index_endpoint = aiplatform.MatchingEngineIndexEndpoint("1234567890123456789")
```

```python
from langchain_google_vertexai import (
    VectorSearchVectorStore,
    VectorSearchVectorStoreDatastore,
)
```

![Langchainassets.png](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA8AAAAIcCAIAAAC2P1AsAACAAElEQVR4Xuy9948cR5bn+Q/0x/3h/nDPe+85J6JEQRAkSIIkSJKiKEqkKFEiRYqSKIqSKIqiKFEUJYqiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiKJKiK
