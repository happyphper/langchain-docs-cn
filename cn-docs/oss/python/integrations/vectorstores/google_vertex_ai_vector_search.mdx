---
title: Google Vertex AI 向量搜索
---
本笔记本展示了如何使用与 `Google Cloud Vertex AI Vector Search` 向量数据库相关的功能。

> [Google Vertex AI Vector Search](https://cloud.google.com/vertex-ai/docs/vector-search/overview)，前身为 Vertex AI Matching Engine，提供业界领先的高规模、低延迟向量数据库。这些向量数据库通常被称为向量相似性匹配或近似最近邻（ANN）服务。

**注意**：LangChain API 期望已创建好端点并部署了索引。索引创建时间可能长达一小时。

> 要了解如何创建索引，请参阅章节 [创建索引并将其部署到端点](#create-index-and-deploy-it-to-an-endpoint)
如果您已有部署好的索引，请跳转到 [从文本创建 VectorStore](#create-vector-store-from-texts)

## 创建索引并将其部署到端点

- 本节演示如何创建新索引并将其部署到端点



```python
# TODO : Set values as per your requirements
# Project and Storage Constants
PROJECT_ID = "<my_project_id>"
REGION = "<my_region>"
BUCKET = "<my_gcs_bucket>"
BUCKET_URI = f"gs://{BUCKET}"

# The number of dimensions for the textembedding-gecko@003 is 768
# If other embedder is used, the dimensions would probably need to change.
DIMENSIONS = 768

# Index Constants
DISPLAY_NAME = "<my_matching_engine_index_id>"
DEPLOYED_INDEX_ID = "<my_matching_engine_endpoint_id>"
```





```python
# Create a bucket.
! gsutil mb -l $REGION -p $PROJECT_ID $BUCKET_URI
```



### 使用 `VertexAIEmbeddings` 作为嵌入模型



```python
from google.cloud import aiplatform
from langchain_google_vertexai import VertexAIEmbeddings
```





```python
aiplatform.init(project=PROJECT_ID, location=REGION, staging_bucket=BUCKET_URI)
```





```python
embedding_model = VertexAIEmbeddings(model_name="text-embedding-005")
```



### 创建空索引

**注意：** 创建索引时，您应从 "BATCH_UPDATE" 或 "STREAM_UPDATE" 中指定一个 "index_update_method"
> 批处理索引适用于您希望批量更新索引的情况，数据是在一段时间内累积存储的，例如每周或每月处理的系统。流式索引适用于您希望在新数据添加到数据存储时立即更新索引数据的情况，例如，如果您有一个书店，并希望尽快在线展示新库存。选择哪种类型很重要，因为设置和要求不同。

有关配置索引的更多详细信息，请参阅 [官方文档](https://cloud.google.com/vertex-ai/docs/vector-search/create-manage-index#create-index-batch)



```python
# NOTE : This operation can take upto 30 seconds
my_index = aiplatform.MatchingEngineIndex.create_tree_ah_index(
    display_name=DISPLAY_NAME,
    dimensions=DIMENSIONS,
    approximate_neighbors_count=150,
    distance_measure_type="DOT_PRODUCT_DISTANCE",
    index_update_method="STREAM_UPDATE",  # allowed values BATCH_UPDATE , STREAM_UPDATE
)
```



### 创建端点



```python
# Create an endpoint
my_index_endpoint = aiplatform.MatchingEngineIndexEndpoint.create(
    display_name=f"{DISPLAY_NAME}-endpoint", public_endpoint_enabled=True
)
```



### 将索引部署到端点



```python
# NOTE : This operation can take upto 20 minutes
my_index_endpoint = my_index_endpoint.deploy_index(
    index=my_index, deployed_index_id=DEPLOYED_INDEX_ID
)

my_index_endpoint.deployed_indexes
```



## 从文本创建向量存储

注意：如果您已有现有的索引和端点，可以使用以下代码加载它们



```python
# TODO : replace 1234567890123456789 with your acutial index ID
my_index = aiplatform.MatchingEngineIndex("1234567890123456789")

# TODO : replace 1234567890123456789 with your acutial endpoint ID
my_index_endpoint = aiplatform.MatchingEngineIndexEndpoint("1234567890123456789")
```





```python
from langchain_google_vertexai import (
    VectorSearchVectorStore,
    VectorSearchVectorStoreDatastore,
)
```

![Langchainassets.png](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA8AAAAIcCAIAAAC2P1AsAACAAElEQVR4Xuy995cVRRzuff+Ge8/7/nDPe+85K6IkQRCUIBIkSUZQJEgUBQRFcgZBQKIEyZIzIlmi5JxDlJxzzjlnd2F32ZkhKf1+7JK2GcIwQ9hifT6Hw+mprq6uqu55vk9VV8/+D0cIIYQQQgjx1PyP8AQhhBBCCCHE45GBFkIIIYQQIgpkoIUQQgghhIgCGWghhBBCCCGiQAZaCCGEEEKIKJCBFkIIIYQQIgpkoIUQQgghhIgCGWghhBBCCCGiQAZaCCGEEEKIKJCBFkIIIYQQIgpkoIUQQgghhIgCGWghhBBCCCGiQAZaCCGEEEKIKJCBFkIIIYQQIgpkoIUQQgghhIgCGWghhBBCCCGiQAZaCCGEEEKIKJCBFkIIIYQQIgpkoIUQQgghhIgCGWghhBBCCCGiQAZaCCGEEEKIKJCBFkIIIYQQIgpkoIUQQgghhIgCGWghhBBCCCGiQAZaCCGEEEKIKJCBFkIIIYQQIgpkoIUQQgghhIgCGWghhBBCCCGiQAZaCCGEEEKIKJCBFkIIIYQQIgpkoIUQQgghhIgCGWghhBBCCCGiQAZaCCGEEEKIKJCBFkIIIYQQIgpkoIUQQgghhIgCGWghhBBCCCGiQAZaCCGEEEKIKHg1DPT169dr1KhRv379P//800ucMWMGib/++qsvY2Ru3769c+fO8NRIrFy5slatWoULFy5atOi333576tSp8BzPiePHj9OoMWPGhKU3adKE9AsXLngpW7duJaVv376+XE/F5s2bw5MiceDAASpQ2KVBgwb+ElJTU9nryyuEsAvpZ4bXz0OHDtXw0bRp07lz5967dy8834PcvXt327Zt4alPRwz9IEQG49Uw0FCpUqW4uLiNGzd6KR999BEpBw8e9OWKwOXLl4sUKdK2bdvwHU9k/fr1mTJlyp49O8JUtmxZTponT54kpKTwfM+DXbt2UX6HDh3C0jt37kz6yJEjvRRaQcrMmTN9uSKAnlatWpV+C9/xRC5dupQjR47XX3+9WrVqHE5XsE092bV///66des+8gAhhE1IPzO2fm7ZsoXm0Ml49AIFCsS5tGnTJjyfj5SUlJIlS3755ZfhO56CFi1acK7wVCH+Y7wyBnr8+PEoQrt27czH06dP87FUqVLm49WrV1EQ/wSDgfBA+vXr18N3uPTv35+jhg0bFh8f7+U5ceIEeZKTk70USiNU3Lx5c+vWrcFgEBnyx56vv/6aj9OmTTMf//zzz7179+7evfvOnTteCXD8+HGKPXz4sJdCmZR848aN7du337p1y58tISHBfPQCABnIdu7cOZO+c+dO0suVK2c+3r17N3fu3FmyZElNTeVjIBCgqhRl9nqcOXOGwi9evGg+UgEKKVGiBB31119/mUS6wl8DcNw5KjJwCipDxaZMmeKPPaNGjTI1pL0TJkxgu0+fPomJiWYvxR46dIia029egYQQykGvaYXpJQrf48KGl00I8YKQfmZs/dziGmj61nyk4ThpUrx5YgqkPmS7du2aSdm2bRsZPv/8c8o3KfTGVhf/2bmOXB1/J1NbPDoGmmZ6V41Wk8f/bIErRYbbt28fOHDg/PnzJpFzkc1//wjx6vLKGGi+tAzcUT3zjR0+fDhfXjN2/+mnn9gV54JYG2lD0cwUC7B37NixaWlp5iMUKVLEcVWmQoUKJuWNN94YNGiQOReJefLkqVy5Mun9XNjg48KFC1EfTzodNw4VLVrUlJA/f36CgeNK1aeffnr/VHEVK1Y0evTee+8VL168WLFiJE6cODEpKalq1aomT6ZMmfr37+/cDwCkU5rZNXjwYMeNXh988IHjRq8PPvjAcaPXokWLcuTIYfJwXnSWxFAo1LBhQ5MYd79bOLuXQsAjbHz11VdeyjfffIO6c2zHjh35WL9+/ThXXpcuXcrG+++/P3XqVHTQaz6y6B1bp04dUmi+qWScOxfize689dZbpUuXLlSoEOmzZ88+fvy4l41EAobJJoR4QUg/M7Z+hhlox32Y1q1bN7Y3bdrktdFcTRIzZ85sUnLmzMlHSuYimpSsWbMuW7aMxH379nHPmMTXXnvNdHK9evVMCuzfv58hEE32bqGaNWuaEZcZKph+MDeM8dA9evSgkDj3evXs2dOrqhCvKK+MgYa6devy3Vu1ahXb5cuX56uIyiMNJNaqVevo0aPff/99nCsxZKhduzYZfvnlF1SlVKlSfGNPnDhBqIhzVRJRIw/STJ6hQ4euWbPGyP2cOXMcNwCwTQnjxo1DcJEDSsD6Oq4Ofvzxx0ZcoEqVKggHEsyovWzZsgQDlHr16tUFCxbkXMhl06ZNOQQVc9wAwDYpKAujecSXj2Tbvn075bC9Z88eEwBQTwphG+nMli2b0dwBAwbE3Y8H7du3Z5tqXL16NUuWLMgTx06bNo3ELl26kKFv375sd+rUaefOnSYS/P777+Rng7rRTOLo0qVL2W7ZsuXGjRubNWsWd19tTfqHH36I4rMLffTHEgLYhAkTSCSEmAejtGjDhg2EHBpIZaZMmbJ8+XKqRJ/TNMcNAGRr0aIFAZv4VLZsWZSaymzevBl19qbBhBAvDulnXMbVz4cN9Lp160hp0KAB21QSB7979248OqW9++67JGKjycCdsGDBAupTo0aNcuXKHTt2jKtJevXq1cnz5ZdfcoHw6PHx8RTOgIFxFI1igERV6QcurjHK3F20onv37nGuaXbuG2guK/2w2IWPlMCdZh5K0EyvtkK8irxKBnru3LlGR86dO+d9w803FmVBQcwTRr6iwWAQ9SlZsqQ58PLly+YJI/JBBrOGj69xnBs5TJ7Dhw/zERFx7gcA/xM95BKVQbLz5csX58KXPzExMc59DLrFpVGjRnw8fvy4OQTRQQqJFiT+9ttvzv0AYEbngMq/8847Zht5MukmAJipETCHm+eMBDC2aRRih34hnbdv36ZkElu3bm3qgDKi72SmVsQ2M3NDyeaRGQGEzGYNH4VkzZqVCpiHgDdv3qQ+aCsBzAQAEws9kGPSvemigQMHkrhw4cK4+/NYJroQckz+JUuWxN1fjEixqLCpDDGbbGaa2wR170mrEOIFIf2My7j6ueUhA21m2clgPgYCgbVr1w4aNChHjhwMKhz3AQIZ/Gugaan5qZAffviBtpvlLvRMnDvPTU2orbdypnDhwt4aaLqU/N514X7gY1JSkjHQ3nMJbjw+Tpo0iarOmzcv7v6NJMQry6tkoFEQvrR8/wcPHszXb/r06c79ryXaat5xhsaNG1+5coXEKlWqhJXgDwAM3+N8r1nw/edj6dKlnfsBAMEyuwg8kydPvl+GM3r0aPZyFqPIiJF3akDBiQFFihR54403Pv30UyIKeSjBcQOAJzpElLj7D7b8mADQvn178/Gzzz6L88UMUzEzc4AckzJu3Lg49yUcrwLFihVz3HNlzpz5fqn/4A8AtI7tMmXKeHvNY0GCigkAyJxJX7NmDarnrXE0/fb+++87DwaAGTNmsD18+HCTbc+ePXFumHfcAEDgNOkHDx6Mu/+yi8dzeQ9dCPEEpJ8ZWD8fNtBcX6+ZI0eOzJIlC4U0a9Ysb968phvDDDTenVvGtIJrykb58uUd97K2a9fOW/5RoECBq1evOg8aaEYRxpEbGFPFuQMhY6BnzZpl0s1aDkrwqi0DLV51XiUDDeaxHUP/N9980yxW69+/PykoEeN+26tWrYr63717l6+3mWNwXJX84osvUJl9+/bF3Rf9+Pj4TJkylShRwvy008qVK+Pc92Oc+zprjgWiAh/XrVtnPi5YsCDOfe6WlpaG0JiY4bjKyCk49bfffksG82NPiCPbDLgdV5SpkskM+fPnJ0iY2ZFff/21QYMGW7du9V6CMXnCAsAvv/zCR6SQ/83PD5l5i169ejmuvvPRLPIzqwMJUWyvXbv2888/Z9e9e/fifKJPfWhL8+bN+Uj4oS3mYZsJALvc98TBPG7zlJ3yX3vtNXTWuR8AzC7zSop5eOfcr6pZM0cAKFSokEm/du0a3V6xYkXzcePGjXSa/9e1hBAvCOlnXAbVzzADzWCJPKRQebqIupUrV85cKby730BzZZ37C7LNzP2tW7eoIRfRcWtlFnhg6LHa8fHxce4QyPj4Tz75JO7+z7lwXkYjbIfcN4eMgTZDH8c16HH3bwNuHsYV3uuMQryivGIGevXq1XEu3g8qo0cEA7RszJgxNWvW9L7hPXv2jHNfQOnSpQt6wbeagGHmPBgEm4VuZvalSpUqnTt3RqQQVqMCYQHAPObLnDlz3bp1a9euzQYShjB5JaD4P//8M9UoXrw4WmNWtrVv337ixInmkaWZ7KGSVMOUCRwS58pxt27dcuXKRSUvXbr05ABAbDPvaiCC5jc+0Sm0FR0fNGiQedzG2Uk3z8iQOQqnvRy1f/9+0pE2mklOyjSzL0WLFqU3CruvbJtAFRYA0FaaFue+mtOoUSOzIM+I/h9//BHnPoQdPHgw4cc8MK1Tp067du3opXfeecdMV/gDgOP+JivZWrVqNXToULIRQf3vFQkhXhDSz4yqn8ZAc0iNGjXoRnojzh2l0EwMMQ3MmTPn1KlTjYulORySlJQU586+05zTp09jmmnF7NmzzZuRDI04F/Y6zl3bTToXmjw4adLpdra5fEePHl2xYgXbXCn6gfS4+wvNjYE2feK47yOaGW7GBqalWgMtXnVeMQONvNarVw+NWL9+vZe4efNmtAkh4Ds/fvx4L2e/fv2KFSuGtpLfLBJATRDrvHnzMhxn+86dO3zVOYpjCR67d+82x6KAHOL/hTVUoHLlyiaQfPrpp943H/1FXIoUKUKZiKNZy5uQkECcePvtt1Ecxt8UZX7DCOEjj1cmEjZixAjOjrRRfzMjEvaHAHr06MHHtLQ07yhEihRCi5eC9jVs2JAKIH+EPS9uzZw5E22lcOKZ99YOwk1OFPbs2bMmj3llnv8XL15s8owdO5ZTeIsRYfv27bQod+7cOXLkoOvoZBN+gsEg6RRongPeuHHD9AY6TsqZM2fM4fXr1zdTU4ZAIECUorZoLoH88uXL3i4hxItD+plR9TPsD6nQIuyy92SPumH0qSfWfNiwYWQwk+uUw9lx8NSEahdw6du3L/3ABU1zYTRiJq3Lly9vnlTAnDlzChYsiK033b5y5cpq1apRPj3m9S2ZOdGGDRvMR1i1ahW3Adk4o3lXVYhXmlfMQAshhBBCCJG+yEALIYQQQggRBTLQQgghhBBCRIEMtBBCCCGEEFEgAy2EEEIIIUQUyEALIYQQQggRBTLQQgghhBBCRIEMtBBCCCGEEFEgAy2EEEIIIUQUyEALIYQQQggRBTLQsfPXX38tXbq0R48enTt3nj59ejAY9Hb5t18aO3bs8P7UamzEx8ePGDEiPPWJJCQkDB06NDz18fz555+rV6/u27dv+/btp02b5nXU5s2b6cwH80bHyZMn/X+h14NTcCKuUc+ePZctW8ZV8+/yZXx5xNDPYcyfP3/Xrl3hqY8hvZopxBOQfjrW6yciM/g+EyZMWLly5a1bt8LyPExsly+2o4RIR2SgY6dx48YffPBB7969BwwYULFixSJFiiQmJpJ+6tSpkiVLhud+8YwcOfKLL74IT40G5DJHjhzhqU/k+PHjRYsWDU99DNevX69SpUrhwoVNp5UuXbp48eJXrlxhFx+/+eab8AOiYcWKFQ/XJDU1tVixYh9//PHAgQN79epVsGDB+vXr37t3j12LFy9u3rx5WP6Xw+7du7Nnzx6eGg20YsyYMeGpj2LNmjUNGjQITxUivZF+Otbr57hx495+++02LvXq1Xv33Xe5ZOfOnQvL5odOqFatWnhqJBhBMY4KTxXCbjKsgWag/Ouvv3bo0IGv5e+//+6fd3wuHD16NFOmTEa84O7du2XLlkXF2N6yZcs777zzQO6XQroEgKho0qQJXjYUCpmPt2/frlSpknGxLygATJ48mWD8559

r1yjA8iIgnhd8GPwuNguXaZ6VeQYaK1yxYkUvG96dujnuDPSPP/5oEjljtmzZOBxpTUtLw4hPmTLFaK/3EJI8JiI0atQIq+2vW9gSDlys//1FfC2enpP6XzjBAVMxs33x4sUZM2Zw0vz589+9e/dpDLR/Jt4YaArhFLjhjRs3Up/u3bu3adPGcf2x5+8faaAJOrjtsGnpr7/+Go/r3DfQ27Zto3Bv1paIQzmEBiysNxlPR8W5BnrmzJlebALi3MMG2nEd8OLFi4mMBI6jR4/6DTR3rJmfNtAzhC1zC3njGU6BseYe45A//vjD9BhRyVunDsRlDPTu3bs5BVfTf8n8y2OEcDKqgYadO3eiXEb9+Up4b7A9Lx5poNEavnXenMFPP/3kiQIb5cqVGz9+vOOuUihatCh7HfdVFVRm+fLlJhsyZ0b2jzPQ5ES1veUZyJOZAnHc2Q48seM+oUNVkVeTB7EjtGDc/Qaa+lNVM79L/mrVqiHxbFMaLt8oBfEgzl3CQZjJnDnzqVOnzLGEkC5duphtA+JrPLr5iD6SZ8yYMQz0Tdzl/1KlSo0bN27fvn0lSpQwDw2pPBKGk2bjtddeY7zhuBMAjC5MOf369XtFf5hPiFeaF62fT2OgkQV00jyXR5EY4T/BQCNBWbJkYcMkTp482UxzPs5At2jRwnvij3tDnRx3cZp5moc58yseckeVnAcNdO/evb1ZWBoS9hYg9cSZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJlZloC64szMsgTUFWdmlqWgrjgzsywBdcWZmWUJqCvOzCxLQF1xZmZZAuqKMzPLElBXnJl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

您是一位专业的 IT 技术文档翻译专家。
请将输入的内容翻译为中文。
要求：
1. 保持技术术语专业。
2. 严禁翻译代码占位符（如 __CODE_BLOCK_N__）、HTML 标签。
3. 严禁翻译 URL 链接、路径。
4. 只返回翻译结果，不要包含任何解释。

### 创建简单的向量存储（无过滤器）

```python
# Input texts
texts = [
    "The cat sat on",
    "the mat.",
    "I like to",
    "eat pizza for",
    "dinner.",
    "The sun sets",
    "in the west.",
]

# Create a Vector Store
vector_store = VectorSearchVectorStore.from_components(
    project_id=PROJECT_ID,
    region=REGION,
    gcs_bucket_name=BUCKET,
    index_id=my_index.name,
    endpoint_id=my_index_endpoint.name,
    embedding=embedding_model,
    stream_update=True,
)

# Add vectors and mapped text chunks to your vectore store
vector_store.add_texts(texts=texts)
```

### 可选：您也可以创建向量并将分块存储在数据存储中

```python
# NOTE : This operation can take upto 20 mins
vector_store = VectorSearchVectorStoreDatastore.from_components(
    project_id=PROJECT_ID,
    region=REGION,
    index_id=my_index.name,
    endpoint_id=my_index_endpoint.name,
    embedding=embedding_model,
    stream_update=True,
)

vector_store.add_texts(texts=texts, is_complete_overwrite=True)
```

```python
# Try running a simialarity search
vector_store.similarity_search("pizza")
```

### 创建带元数据过滤器的向量存储

```python
# Input text with metadata
record_data = [
    {
        "description": "A versatile pair of dark-wash denim jeans."
        "Made from durable cotton with a classic straight-leg cut, these jeans"
        " transition easily from casual days to dressier occasions.",
        "price": 65.00,
        "color": "blue",
        "season": ["fall", "winter", "spring"],
    },
    {
        "description": "A lightweight linen button-down shirt in a crisp white."
        " Perfect for keeping cool with breathable fabric and a relaxed fit.",
        "price": 34.99,
        "color": "white",
        "season": ["summer", "spring"],
    },
    {
        "description": "A soft, chunky knit sweater in a vibrant forest green. "
        "The oversized fit and cozy wool blend make this ideal for staying warm "
        "when the temperature drops.",
        "price": 89.99,
        "color": "green",
        "season": ["fall", "winter"],
    },
    {
        "description": "A classic crewneck t-shirt in a soft, heathered blue. "
        "Made from comfortable cotton jersey, this t-shirt is a wardrobe essential "
        "that works for every season.",
        "price": 19.99,
        "color": "blue",
        "season": ["fall", "winter", "summer", "spring"],
    },
    {
        "description": "A flowing midi-skirt in a delicate floral print. "
        "Lightweight and airy, this skirt adds a touch of feminine style "
        "to warmer days.",
        "price": 45.00,
        "color": "white",
        "season": ["spring", "summer"],
    },
]
```

```python
# Parse and prepare input data

texts = []
metadatas = []
for record in record_data:
    record = record.copy()
    page_content = record.pop("description")
    texts.append(page_content)
    if isinstance(page_content, str):
        metadata = {**record}
        metadatas.append(metadata)
```

```python
# Inspect metadatas
metadatas
```

```python
# NOTE : This operation can take more than 20 mins
vector_store = VectorSearchVectorStore.from_components(
    project_id=PROJECT_ID,
    region=REGION,
    gcs_bucket_name=BUCKET,
    index_id=my_index.name,
    endpoint_id=my_index_endpoint.name,
    embedding=embedding_model,
)

vector_store.add_texts(texts=texts, metadatas=metadatas, is_complete_overwrite=True)
```

```python
from google.cloud.aiplatform.matching_engine.matching_engine_index_endpoint import (
    Namespace,
    NumericNamespace,
)
```

```python
# Try running a simple similarity search

# Below code should return 5 results
vector_store.similarity_search("shirt", k=5)
```

```python
# Try running a similarity search with text filter
filters = [Namespace(name="season", allow_tokens=["spring"])]

# Below code should return 4 results now
vector_store.similarity_search("shirt", k=5, filter=filters)
```

```python
# Try running a similarity search with combination of text and numeric filter
filters = [Namespace(name="season", allow_tokens=["spring"])]
numeric_filters = [NumericNamespace(name="price", value_float=40.0, op="LESS")]

# Below code should return 2 results now
vector_store.similarity_search(
    "shirt", k=5, filter=filters, numeric_filter=numeric_filters
)
```

### 将向量存储用作检索器

```python
# Initialize the vectore_store as retriever
retriever = vector_store.as_retriever()
```

```python
# perform simple similarity search on retriever
retriever.invoke("What are my options in breathable fabric?")
```

```python
# Try running a similarity search with text filter
filters = [Namespace(name="season", allow_tokens=["spring"])]

retriever.search_kwargs = {"filter": filters}

# perform similarity search with filters on retriever
retriever.invoke("What are my options in breathable fabric?")
```

```python
# Try running a similarity search with combination of text and numeric filter
filters = [Namespace(name="season", allow_tokens=["spring"])]
numeric_filters = [NumericNamespace(name="price", value_float=40.0, op="LESS")]


retriever.search_kwargs = {"filter": filters, "numeric_filter": numeric_filters}

retriever.invoke("What are my options in breathable fabric?")
```

### 在问答链中结合检索器使用过滤器

```python
from langchain_google_vertexai import VertexAI

llm = VertexAI(model_name="gemini-pro")
```

```python
from langchain_classic.chains import RetrievalQA

filters = [Namespace(name="season", allow_tokens=["spring"])]
numeric_filters = [NumericNamespace(name="price", value_float=40.0, op="LESS")]

retriever.search_kwargs = {"k": 2, "filter": filters, "numeric_filter": numeric_filters}

retrieval_qa = RetrievalQA.from_chain_type(
    llm=llm,
    chain_type="stuff",
    retriever=retriever,
    return_source_documents=True,
)

question = "What are my options in breathable fabric?"
response = retrieval_qa({"query": question})
print(f"{response['result']}")
print("REFERENCES")
print(f"{response['source_documents']}")
```

## 读取、分块、向量化并索引 PDF 文件

```python
!pip install pypdf
```

```python
from langchain_community.document_loaders import PyPDFLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
```

```python
loader = PyPDFLoader("https://arxiv.org/pdf/1706.03762.pdf")
pages = loader.load()
```

```python
text_splitter = RecursiveCharacterTextSplitter(
    # Set a really small chunk size, just to show.
    chunk_size=1000,
    chunk_overlap=20,
    length_function=len,
    is_separator_regex=False,
)
doc_splits = text_splitter.split_documents(pages)
```

```python
texts = [doc.page_content for doc in doc_splits]
metadatas = [doc.metadata for doc in doc_splits]
```

```python
texts[0]
```

```python
# Inspect Metadata of 1st page
metadatas[0]
```

```python
vector_store = VectorSearchVectorStore.from_components(
    project_id=PROJECT_ID,
    region=REGION,
    gcs_bucket_name=BUCKET,
    index_id=my_index.name,
    endpoint_id=my_index_endpoint.name,
    embedding=embedding_model,
)

vector_store.add_texts(texts=texts, metadatas=metadatas, is_complete_overwrite=True)
```

```python
vector_store = VectorSearchVectorStore.from_components(
    project_id=PROJECT_ID,
    region=REGION,
    gcs_bucket_name=BUCKET,
    index_id=my_index.name,
    endpoint_id=my_index_endpoint.name,
    embedding=embedding_model,
)
```

## 混合搜索

向量搜索支持混合搜索，这是信息检索（IR）中一种流行的架构模式，它结合了语义搜索和关键词搜索（也称为基于标记的搜索）。通过混合搜索，开发者可以充分利用这两种方法的优势，有效提供更高的搜索质量。
点击[此处](https://cloud.google.com/vertex-ai/docs/vector-search/about-hybrid-search)了解更多。

为了使用混合搜索，我们需要拟合一个稀疏嵌入向量化器，并在向量搜索集成之外处理嵌入。
稀疏嵌入向量化器的一个例子是 sklearn 的 TfidfVectorizer，但也可以使用其他技术，例如 BM25。

```python
# Define some sample data
texts = [
    "The cat sat on",
    "the mat.",
    "I like to",
    "eat pizza for",
    "dinner.",
    "The sun sets",
    "in the west.",
]

# optional IDs
ids = ["i_" + str(i + 1) for i in range(len(texts))]

# optional metadata
metadatas = [{"my_metadata": i} for i in range(len(texts))]
```

```python
from sklearn.feature_extraction.text import TfidfVectorizer

# Fit the TFIDF Vectorizer (This is usually done on a very large corpus of data to make sure that word statistics generalize well on new data)
vectorizer = TfidfVectorizer()
vectorizer.fit(texts)
```

```python
# Utility function to transform text into a TF-IDF Sparse Vector
def get_sparse_embedding(tfidf_vectorizer, text):
    tfidf_vector = tfidf_vectorizer.transform([text])
    values = []
    dims = []
    for i, tfidf_value in enumerate(tfidf_vector.data):
        values.append(float(tfidf_value))
        dims.append(int(tfidf_vector.indices[i]))
    return {"values": values, "dimensions": dims}
```

```python
# semantic (dense) embeddings
embeddings = embedding_model.embed_documents(texts)
# tfidf (sparse) embeddings
sparse_embeddings = [get_sparse_embedding(vectorizer, x) for x in texts]
```

```python
sparse_embeddings[0]
```

```python
# Add the dense and sparse embeddings in Vector Search

vector_store.add_texts_with_embeddings(
    texts=texts,
    embeddings=embeddings,
    sparse_embeddings=sparse_embeddings,
    ids=ids,
    metadatas=metadatas,
)
```

```python
# Run hybrid search
query = "the cat"
embedding = embedding_model.embed_query(query)
sparse_embedding = get_sparse_embedding(vectorizer, query)

vector_store.similarity_search_by_vector_with_score(
    embedding=embedding,
    sparse_embedding=sparse_embedding,
    k=5,
    rrf_ranking_alpha=0.7,  # 0.7 weight to dense and 0.3 weight to sparse
)
```

