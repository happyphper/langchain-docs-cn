---
title: Marqo
---
本笔记本展示了如何使用与 Marqo 向量存储相关的功能。

>[Marqo](https://www.marqo.ai/) 是一个开源的向量搜索引擎。Marqo 允许您存储和查询多模态数据，例如文本和图像。Marqo 使用大量开源模型为您创建向量，您也可以提供自己的微调模型，Marqo 将为您处理加载和推理。

您需要安装 `langchain-community`，使用 `pip install -qU langchain-community` 来使用此集成。

要使用我们的 Docker 镜像运行此笔记本，请先运行以下命令以获取 Marqo：

```
docker pull marqoai/marqo:latest
docker rm -f marqo
docker run --name marqo -it --privileged -p 8882:8882 --add-host host.docker.internal:host-gateway marqoai/marqo:latest
```

```python
pip install -qU  marqo
```

```python
from langchain_community.document_loaders import TextLoader
from langchain_community.vectorstores import Marqo
from langchain_text_splitters import CharacterTextSplitter
```

```python
from langchain_community.document_loaders import TextLoader

loader = TextLoader("../../how_to/state_of_the_union.txt")
documents = loader.load()
text_splitter = CharacterTextSplitter(chunk_size=1000, chunk_overlap=0)
docs = text_splitter.split_documents(documents)
```

```python
import marqo

# 初始化 marqo
marqo_url = "http://localhost:8882"  # 如果使用 marqo cloud，请替换为您的端点 (console.marqo.ai)
marqo_api_key = ""  # 如果使用 marqo cloud，请替换为您的 API 密钥 (console.marqo.ai)

client = marqo.Client(url=marqo_url, api_key=marqo_api_key)

index_name = "langchain-demo"

docsearch = Marqo.from_documents(docs, index_name=index_name)

query = "What did the president say about Ketanji Brown Jackson"
result_docs = docsearch.similarity_search(query)
```

```text
索引 langchain-demo 已存在。
```

```python
print(result_docs[0].page_content)
```

```text
今晚。我呼吁参议院：通过《自由投票法案》。通过《约翰·刘易斯投票权法案》。同时，通过《披露法案》，让美国人知道谁在资助我们的选举。

今晚，我想向一位毕生致力于服务这个国家的人致敬：斯蒂芬·布雷耶大法官——一位陆军退伍军人、宪法学者、即将退休的美国最高法院大法官。布雷耶大法官，感谢您的服务。

总统最严肃的宪法职责之一就是提名某人担任美国最高法院大法官。

我在四天前做到了这一点，当时我提名了联邦上诉法院法官凯坦吉·布朗·杰克逊。她是我们国家顶级的法律人才之一，将继续布雷耶大法官的卓越传统。
```

```python
result_docs = docsearch.similarity_search_with_score(query)
print(result_docs[0][0].page_content, result_docs[0][1], sep="\n")
```

```text
今晚。我呼吁参议院：通过《自由投票法案》。通过《约翰·刘易斯投票权法案》。同时，通过《披露法案》，让美国人知道谁在资助我们的选举。

今晚，我想向一位毕生致力于服务这个国家的人致敬：斯蒂芬·布雷耶大法官——一位陆军退伍军人、宪法学者、即将退休的美国最高法院大法官。布雷耶大法官，感谢您的服务。

总统最严肃的宪法职责之一就是提名某人担任美国最高法院大法官。

我在四天前做到了这一点，当时我提名了联邦上诉法院法官凯坦吉·布朗·杰克逊。她是我们国家顶级的法律人才之一，将继续布雷耶大法官的卓越传统。
0.68647254
```

## 附加功能

Marqo 作为向量存储的强大功能之一是您可以使用外部创建的索引。例如：

+ 如果您有来自另一个应用程序的图像和文本对数据库，您可以直接在 LangChain 中使用 Marqo 向量存储。请注意，使用您自己的多模态索引将禁用 `add_texts` 方法。

+ 如果您有一个文本文档数据库，您可以将其引入 LangChain 框架，并通过 `add_texts` 添加更多文本。

返回的文档可以通过在搜索方法中向 `page_content_builder` 回调传递您自己的函数来自定义。

#### 多模态示例

```python
# 使用新索引
index_name = "langchain-multimodal-demo"

# 以防演示重新运行
try:
    client.delete_index(index_name)
except Exception:
    print(f"创建 {index_name}")

# 此索引可能由另一个系统创建
settings = {"treat_urls_and_pointers_as_images": True, "model": "ViT-L/14"}
client.create_index(index_name, **settings)
client.index(index_name).add_documents(
    [
        # 公交车图片
        {
            "caption": "Bus",
            "image": "https://raw.githubusercontent.com/marqo-ai/marqo/mainline/examples/ImageSearchGuide/data/image4.jpg",
        },
        # 飞机图片
        {
            "caption": "Plane",
            "image": "https://raw.githubusercontent.com/marqo-ai/marqo/mainline/examples/ImageSearchGuide/data/image2.jpg",
        },
    ],
)
```

```text
{'errors': False,
 'processingTimeMs': 2090.2822139996715,
 'index_name': 'langchain-multimodal-demo',
 'items': [{'_id': 'aa92fc1c-1fb2-4d86-b027-feb507c419f7',
   'result': 'created',
   'status': 201},
  {'_id': '5142c258-ef9f-4bf2-a1a6-2307280173a0',
   'result': 'created',
   'status': 201}]}
```

```python
def get_content(res):
    """将 Marqo 的文档格式化为用作 page_content 的文本的辅助函数"""
    return f"{res['caption']}: {res['image']}"


docsearch = Marqo(client, index_name, page_content_builder=get_content)


query = "vehicles that fly"
doc_results = docsearch.similarity_search(query)
```

```python
for doc in doc_results:
    print(doc.page_content)
```

```text
Plane: https://raw.githubusercontent.com/marqo-ai/marqo/mainline/examples/ImageSearchGuide/data/image2.jpg
Bus: https://raw.githubusercontent.com/marqo-ai/marqo/mainline/examples/ImageSearchGuide/data/image4.jpg
```

#### 纯文本示例

```python
# 使用新索引
index_name = "langchain-byo-index-demo"

# 以防演示重新运行
try:
    client.delete_index(index_name)
except Exception:
    print(f"创建 {index_name}")

# 此索引可能由另一个系统创建
client.create_index(index_name)
client.index(index_name).add_documents(
    [
        {
            "Title": "Smartphone",
            "Description": "A smartphone is a portable computer device that combines mobile telephone "
            "functions and computing functions into one unit.",
        },
        {
            "Title": "Telephone",
            "Description": "A telephone is a telecommunications device that permits two or more users to"
            "conduct a conversation when they are too far apart to be easily heard directly.",
        },
    ],
)
```

```text
{'errors': False,
 'processingTimeMs': 139.2144540004665,
 'index_name': 'langchain-byo-index-demo',
 'items': [{'_id': '27c05a1c-b8a9-49a5-ae73-fbf1eb51dc3f',
   'result': 'created',
   'status': 201},
  {'_id': '6889afe0-e600-43c1-aa3b-1d91bf6db274',
   'result': 'created',
   'status': 201}]}
```

```python
# 注意：尽管文档中的字段名不同，文本索引仍保留使用 add_texts 的能力
# 这是因为 page_content_builder 回调允许您根据需要处理这些文档字段


def get_content(res):
    """将 Marqo 的文档格式化为用作 page_content 的文本的辅助函数"""
    if "text" in res:
        return res["text"]
    return res["Description"]


docsearch = Marqo(client, index_name, page_content_builder=get_content)

docsearch.add_texts(["This is a document that is about elephants"])
```

```python
['9986cc72-adcd-4080-9d74-265c173a9ec3']
```

```python
query = "modern communications devices"
doc_results = docsearch.similarity_search(query)

print(doc_results[0].page_content)
```

```text
A smartphone is a portable computer device that combines mobile telephone functions and computing functions into one unit.
```

```python
query = "elephants"
doc_results = docsearch.similarity_search(query, page_content_builder=get_content)

print(doc_results[0].page_content)
```

```text
This is a document that is about elephants
```

## 加权查询

我们还公开了 Marqo 的加权查询，这是一种组合复杂语义搜索的强大方式。

```python
query = {"communications devices": 1.0}
doc_results = docsearch.similarity_search(query)
print(doc_results[0].page_content)
```

```text
A smartphone is a portable computer device that combines mobile telephone functions and computing functions into one unit.
```

```python
query = {"communications devices": 1.0, "technology post 2000": -1.0}
doc_results = docsearch.similarity_search(query)
print(doc_results[0].page_content)
```

```text
A telephone is a telecommunications device that permits two or more users toconduct a conversation when they are too far apart to be easily heard directly.
```

# 带来源的问答

本节展示了如何将 Marqo 用作 `RetrievalQAWithSourcesChain` 的一部分。Marqo 将执行对信息来源的搜索。

```python
import getpass
import os

from langchain_classic.chains import RetrievalQAWithSourcesChain
from langchain_openai import OpenAI

if "OPENAI_API_KEY" not in os.environ:
    os.environ["OPENAI_API_KEY"] = getpass.getpass("OpenAI API Key:")
```

```text
OpenAI API Key:········
```

```python
with open("../../how_to/state_of_the_union.txt") as f:
    state_of_the_union = f.read()
text_splitter = CharacterTextSplitter(chunk_size=1000, chunk_overlap=0)
texts = text_splitter.split_text(state_of_the_union)
```

```python
index_name = "langchain-qa-with-retrieval"
docsearch = Marqo.from_documents(docs, index_name=index_name)
```

```text
索引 langchain-qa-with-retrieval 已存在。
```

```python
chain = RetrievalQAWithSourcesChain.from_chain_type(
    OpenAI(temperature=0), chain_type="stuff", retriever=docsearch.as_retriever()
)
```

```python
chain(
    {"question": "What did the president say about Justice Breyer"},
    return_only_outputs=True,
)
```

```text
{'answer': ' 总统向布雷耶大法官致敬，感谢他的服务，并指出他是一位即将退休的美国最高法院大法官。\n',
 'sources': '../../../state_of_the_union.txt'}
```
