---
title: æ„å»ºæ”¯æŒäººå·¥è½¬æ¥çš„å®¢æˆ·æ”¯æŒç³»ç»Ÿ
sidebarTitle: 'Handoffs: Customer support'
---
import ChatModelTabsPy from '/snippets/chat-model-tabs.mdx';
import ChatModelTabsJs from '/snippets/chat-model-tabs-js.mdx';

[çŠ¶æ€æœºæ¨¡å¼](/oss/langchain/multi-agent/handoffs)æè¿°äº†æ™ºèƒ½ä½“ï¼ˆagentï¼‰åœ¨ä»»åŠ¡çš„ä¸åŒçŠ¶æ€é—´ç§»åŠ¨æ—¶ï¼Œå…¶è¡Œä¸ºéšä¹‹æ”¹å˜çš„å·¥ä½œæµã€‚æœ¬æ•™ç¨‹å±•ç¤ºäº†å¦‚ä½•é€šè¿‡å·¥å…·è°ƒç”¨ï¼ˆtool callsï¼‰æ¥å®ç°çŠ¶æ€æœºï¼Œä»è€ŒåŠ¨æ€æ”¹å˜å•ä¸ªæ™ºèƒ½ä½“çš„é…ç½®â€”â€”æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–°å…¶å¯ç”¨å·¥å…·å’ŒæŒ‡ä»¤ã€‚çŠ¶æ€å¯ä»¥ä»å¤šä¸ªæ¥æºç¡®å®šï¼šæ™ºèƒ½ä½“çš„è¿‡å¾€æ“ä½œï¼ˆå·¥å…·è°ƒç”¨ï¼‰ã€å¤–éƒ¨çŠ¶æ€ï¼ˆä¾‹å¦‚ API è°ƒç”¨ç»“æœï¼‰ï¼Œç”šè‡³æ˜¯åˆå§‹ç”¨æˆ·è¾“å…¥ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡è¿è¡Œåˆ†ç±»å™¨æ¥ç¡®å®šç”¨æˆ·æ„å›¾ï¼‰ã€‚

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œä½ å°†æ„å»ºä¸€ä¸ªå®¢æˆ·æ”¯æŒæ™ºèƒ½ä½“ï¼Œå…¶åŠŸèƒ½å¦‚ä¸‹ï¼š

-   åœ¨ç»§ç»­ä¹‹å‰æ”¶é›†ä¿ä¿®ä¿¡æ¯ã€‚
-   å°†é—®é¢˜åˆ†ç±»ä¸ºç¡¬ä»¶æˆ–è½¯ä»¶é—®é¢˜ã€‚
-   æä¾›è§£å†³æ–¹æ¡ˆæˆ–å‡çº§è‡³äººå·¥æ”¯æŒã€‚
-   åœ¨å¤šè½®å¯¹è¯ä¸­ç»´æŒä¼šè¯çŠ¶æ€ã€‚

ä¸[å­æ™ºèƒ½ä½“æ¨¡å¼](/oss/langchain/multi-agent/subagents-personal-assistant)ï¼ˆå…¶ä¸­å­æ™ºèƒ½ä½“ä½œä¸ºå·¥å…·è¢«è°ƒç”¨ï¼‰ä¸åŒï¼Œ**çŠ¶æ€æœºæ¨¡å¼**ä½¿ç”¨å•ä¸ªæ™ºèƒ½ä½“ï¼Œå…¶é…ç½®æ ¹æ®å·¥ä½œæµè¿›åº¦è€Œå˜åŒ–ã€‚æ¯ä¸ªâ€œæ­¥éª¤â€åªæ˜¯åŒä¸€ä¸ªåº•å±‚æ™ºèƒ½ä½“çš„ä¸åŒé…ç½®ï¼ˆç³»ç»Ÿæç¤ºè¯ + å·¥å…·ï¼‰ï¼Œæ ¹æ®çŠ¶æ€åŠ¨æ€é€‰æ‹©ã€‚

ä»¥ä¸‹æ˜¯æˆ‘ä»¬å°†è¦æ„å»ºçš„å·¥ä½œæµï¼š

```mermaid
%%{init: {'theme':'base', 'themeVariables': {'primaryColor':'#4CAF50','primaryTextColor':'#fff','primaryBorderColor':'#2E7D32','lineColor':'#666','secondaryColor':'#FF9800','tertiaryColor':'#2196F3'}}}%%
flowchart TD
    %% Start
    Start([ğŸ’¬ Customer reports<br>an issue]) --> Warranty{Is the device<br>under warranty?}

    %% Warranty check
    Warranty -->|âœ… Yes| IssueType{What type<br>of issue?}
    Warranty -->|âŒ No| OutOfWarranty{What type<br>of issue?}

    %% In-Warranty branch
    IssueType -->|ğŸ”© Hardware| Repair[Provide warranty<br>repair instructions]
    IssueType -->|ğŸ’» Software| Troubleshoot[Provide troubleshooting<br>steps]

    %% Out-of-Warranty branch
    OutOfWarranty -->|ğŸ”© Hardware| Escalate[Escalate to human<br>for paid repair options]
    OutOfWarranty -->|ğŸ’» Software| Troubleshoot

    %% Troubleshooting follow-up
    Troubleshoot --> Close([âœ… Issue Resolved])
    Repair --> Close
    Escalate --> Close

    %% === Styling ===
    classDef startEnd fill:#4CAF50,stroke:#2E7D32,stroke-width:2px,color:#fff
    classDef decisionNode fill:#2196F3,stroke:#1565C0,stroke-width:2px,color:#fff
    classDef actionNode fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
    classDef escalateNode fill:#f44336,stroke:#c62828,stroke-width:2px,color:#fff

    class Start,Close startEnd
    class Warranty,IssueType,OutOfWarranty decisionNode
    class Repair,Troubleshoot actionNode
    class Escalate escalateNode
```

## ç¯å¢ƒè®¾ç½®

### å®‰è£…

æœ¬æ•™ç¨‹éœ€è¦ `langchain` åŒ…ï¼š

:::python
<CodeGroup>
```bash pip
pip install langchain
```
```bash uv
uv add langchain
```
```bash conda
conda install langchain -c conda-forge
```
</CodeGroup>
:::

:::js
<CodeGroup>
```bash npm
npm install langchain
```
```bash yarn
yarn add langchain
```
```bash pnpm
pnpm add langchain
```
</CodeGroup>
:::

æ›´å¤šè¯¦æƒ…ï¼Œè¯·å‚é˜…æˆ‘ä»¬çš„[å®‰è£…æŒ‡å—](/oss/langchain/install)ã€‚

### LangSmith

è®¾ç½® [LangSmith](https://smith.langchain.com) ä»¥æ£€æŸ¥æ™ºèƒ½ä½“å†…éƒ¨å‘ç”Ÿçš„æƒ…å†µã€‚ç„¶åè®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

:::python
<CodeGroup>
```bash bash
export LANGSMITH_TRACING="true"
export LANGSMITH_API_KEY="..."
```
```python python
import getpass
import os

os.environ["LANGSMITH_TRACING"] = "true"
os.environ["LANGSMITH_API_KEY"] = getpass.getpass()
```
</CodeGroup>
:::

:::js
<CodeGroup>
```bash bash
export LANGSMITH_TRACING="true"
export LANGSMITH_API_KEY="..."
```
```typescript typescript
process.env.LANGSMITH_TRACING = "true";
process.env.LANGSMITH_API_KEY = "...";
```
</CodeGroup>
:::

### é€‰æ‹© LLM

ä» LangChain çš„é›†æˆå¥—ä»¶ä¸­é€‰æ‹©ä¸€ä¸ªèŠå¤©æ¨¡å‹ï¼š

:::python
<ChatModelTabsPy />
:::

:::js
<ChatModelTabsJs />
:::

## 1. å®šä¹‰è‡ªå®šä¹‰çŠ¶æ€

é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰çŠ¶æ€æ¨¡å¼ï¼Œç”¨äºè·Ÿè¸ªå½“å‰å¤„äºå“ªä¸ªæ´»åŠ¨æ­¥éª¤ï¼š

:::python
```python
from langchain.agents import AgentState
from typing_extensions import NotRequired
from typing import Literal

# å®šä¹‰å¯èƒ½çš„å·¥ä½œæµæ­¥éª¤
SupportStep = Literal["warranty_collector", "issue_classifier", "resolution_specialist"]  # [!code highlight]

class SupportState(AgentState):  # [!code highlight]
    """å®¢æˆ·æ”¯æŒå·¥ä½œæµçš„çŠ¶æ€ã€‚"""
    current_step: NotRequired[SupportStep]  # [!code highlight]
    warranty_status: NotRequired[Literal["in_warranty", "out_of_warranty"]]
    issue_type: NotRequired[Literal["hardware", "software"]]
```
:::

:::js
```typescript
import { z } from "zod";

// å®šä¹‰å¯èƒ½çš„å·¥ä½œæµæ­¥éª¤
const SupportStepSchema = z.enum(["warranty_collector", "issue_classifier", "resolution_specialist"]);  // [!code highlight]
const WarrantyStatusSchema = z.enum(["in_warranty", "out_of_warranty"]);
const IssueTypeSchema = z.enum(["hardware", "software"]);

// å®¢æˆ·æ”¯æŒå·¥ä½œæµçš„çŠ¶æ€
const SupportStateSchema = z.object({  // [!code highlight]
  currentStep: SupportStepSchema.optional(),  // [!code highlight]
  warrantyStatus: WarrantyStatusSchema.optional(),
  issueType: IssueTypeSchema.optional(),
});
```
:::

`current_step` å­—æ®µæ˜¯çŠ¶æ€æœºæ¨¡å¼çš„æ ¸å¿ƒâ€”â€”å®ƒå†³å®šäº†åœ¨æ¯ä¸ªå›åˆåŠ è½½å“ªä¸ªé…ç½®ï¼ˆæç¤ºè¯ + å·¥å…·ï¼‰ã€‚

## 2. åˆ›å»ºç®¡ç†å·¥ä½œæµçŠ¶æ€çš„å·¥å…·

åˆ›å»ºç”¨äºæ›´æ–°å·¥ä½œæµçŠ¶æ€çš„å·¥å…·ã€‚è¿™äº›å·¥å…·å…è®¸æ™ºèƒ½ä½“è®°å½•ä¿¡æ¯å¹¶è½¬æ¢åˆ°ä¸‹ä¸€æ­¥ã€‚

å…³é”®ç‚¹æ˜¯ä½¿ç”¨ `Command` æ¥æ›´æ–°çŠ¶æ€ï¼ŒåŒ…æ‹¬ `current_step` å­—æ®µï¼š

:::python
```python
from langchain.tools import tool, ToolRuntime
from langchain.messages import ToolMessage
from langgraph.types import Command

@tool
def record_warranty_status(
    status: Literal["in_warranty", "out_of_warranty"],
    runtime: ToolRuntime[None, SupportState],
) -> Command:  # [!code highlight]
    """è®°å½•å®¢æˆ·çš„ä¿ä¿®çŠ¶æ€å¹¶è½¬æ¢åˆ°é—®é¢˜åˆ†ç±»æ­¥éª¤ã€‚"""
    return Command(  # [!code highlight]
        update={  # [!code highlight]
            "messages": [
                ToolMessage(
                    content=f"Warranty status recorded as: {status}",
                    tool_call_id=runtime.tool_call_id,
                )
            ],
            "warranty_status": status,
            "current_step": "issue_classifier",  # [!code highlight]
        }
    )


@tool
def record_issue_type(
    issue_type: Literal["hardware", "software"],
    runtime: ToolRuntime[None, SupportState],
) -> Command:  # [!code highlight]
    """è®°å½•é—®é¢˜ç±»å‹å¹¶è½¬æ¢åˆ°è§£å†³æ–¹æ¡ˆä¸“å®¶æ­¥éª¤ã€‚"""
    return Command(  # [!code highlight]
        update={  # [!code highlight]
            "messages": [
                ToolMessage(
                    content=f"Issue type recorded as: {issue_type}",
                    tool_call_id=runtime.tool_call_id,
                )
            ],
            "issue_type": issue_type,
            "current_step": "resolution_specialist",  # [!code highlight]
        }
    )


@tool
def escalate_to_human(reason: str) -> str:
    """å°†æ¡ˆä¾‹å‡çº§ç»™äººå·¥æ”¯æŒä¸“å®¶ã€‚"""
    # åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œè¿™å°†åˆ›å»ºå·¥å•ã€é€šçŸ¥å·¥ä½œäººå‘˜ç­‰ã€‚
    return f"Escalating to human support. Reason: {reason}"


@tool
def provide_solution(solution: str) -> str:
    """ä¸ºå®¢æˆ·çš„é—®é¢˜æä¾›è§£å†³æ–¹æ¡ˆã€‚"""
    return f"Solution provided: {solution}"
```
:::

:::js
```typescript
import { z } from "zod";
import { tool, ToolMessage, type ToolRuntime } from "langchain";
import { Command } from "@langchain/langgraph";

const recordWarrantyStatus = tool(
  async (input, config: ToolRuntime<typeof SupportStateSchema>) => {
    return new Command({ // [!code highlight]
      update: { // [!code highlight]
        messages: [
          new ToolMessage({
            content: `ä¿ä¿®çŠ¶æ€å·²è®°å½•ä¸ºï¼š${input.status}`,
            tool_call_id: config.toolCallId,
          }),
        ],
        warrantyStatus: input.status,
        currentStep: "issue_classifier", // [!code highlight]
      },
    });
  },
  {
    name: "record_warranty_status",
    description:
      "è®°å½•å®¢æˆ·çš„ä¿ä¿®çŠ¶æ€å¹¶è¿‡æ¸¡åˆ°é—®é¢˜åˆ†ç±»é˜¶æ®µã€‚",
    schema: z.object({
      status: WarrantyStatusSchema,
    }),
  }
);

const recordIssueType = tool(
  async (input, config: ToolRuntime<typeof SupportStateSchema>) => {
    return new Command({ // [!code highlight]
      update: { // [!code highlight]
        messages: [
          new ToolMessage({
            content: `é—®é¢˜ç±»å‹å·²è®°å½•ä¸ºï¼š${input.issueType}`,
            tool_call_id: config.toolCallId,
          }),
        ],
        issueType: input.issueType,
        currentStep: "resolution_specialist", // [!code highlight]
      },
    });
  },
  {
    name: "record_issue_type",
    description:
      "è®°å½•é—®é¢˜ç±»å‹å¹¶è¿‡æ¸¡åˆ°è§£å†³æ–¹æ¡ˆä¸“å®¶é˜¶æ®µã€‚",
    schema: z.object({
      issueType: IssueTypeSchema,
    }),
  }
);

const escalateToHuman = tool(
  async (input) => {
    // åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œè¿™å°†åˆ›å»ºå·¥å•ã€é€šçŸ¥å·¥ä½œäººå‘˜ç­‰ã€‚
    return `æ­£åœ¨å‡çº§è‡³äººå·¥æ”¯æŒã€‚åŸå› ï¼š${input.reason}`;
  },
  {
    name: "escalate_to_human",
    description: "å°†æ¡ˆä¾‹å‡çº§è‡³äººå·¥æ”¯æŒä¸“å®¶ã€‚",
    schema: z.object({
      reason: z.string(),
    }),
  }
);

const provideSolution = tool(
  async (input) => {
    return `æä¾›çš„è§£å†³æ–¹æ¡ˆï¼š${input.solution}`;
  },
  {
    name: "provide_solution",
    description: "ä¸ºå®¢æˆ·çš„é—®é¢˜æä¾›è§£å†³æ–¹æ¡ˆã€‚",
    schema: z.object({
      solution: z.string(),
    }),
  }
);
```
:::

è¯·æ³¨æ„ `record_warranty_status` å’Œ `record_issue_type` å¦‚ä½•è¿”å› `Command` å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡æ—¢æ›´æ–°æ•°æ®ï¼ˆ`warranty_status`ã€`issue_type`ï¼‰ä¹Ÿæ›´æ–° `current_step`ã€‚è¿™å°±æ˜¯çŠ¶æ€æœºçš„å·¥ä½œæ–¹å¼â€”â€”å·¥å…·æ§åˆ¶å·¥ä½œæµçš„è¿›å±•ã€‚

## 3. å®šä¹‰æ­¥éª¤é…ç½®

ä¸ºæ¯ä¸ªæ­¥éª¤å®šä¹‰æç¤ºè¯å’Œå·¥å…·ã€‚é¦–å…ˆï¼Œå®šä¹‰æ¯ä¸ªæ­¥éª¤çš„æç¤ºè¯ï¼š

<Accordion title="æŸ¥çœ‹å®Œæ•´çš„æç¤ºè¯å®šä¹‰">

:::python
```python
# å°†æç¤ºè¯å®šä¹‰ä¸ºå¸¸é‡ä»¥ä¾¿å¼•ç”¨
WARRANTY_COLLECTOR_PROMPT = """æ‚¨æ˜¯ä¸€åå®¢æˆ·æ”¯æŒä»£ç†ï¼Œæ­£åœ¨å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜ã€‚

å½“å‰é˜¶æ®µï¼šä¿ä¿®éªŒè¯

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. çƒ­æƒ…é—®å€™å®¢æˆ·
2. è¯¢é—®ä»–ä»¬çš„è®¾å¤‡æ˜¯å¦åœ¨ä¿ä¿®æœŸå†…
3. ä½¿ç”¨ record_warranty_status è®°å½•ä»–ä»¬çš„å›å¤å¹¶è¿›å…¥ä¸‹ä¸€æ­¥

ä¿æŒå¯¹è¯æ€§å’Œå‹å¥½æ€§ã€‚ä¸è¦ä¸€æ¬¡é—®å¤šä¸ªé—®é¢˜ã€‚"""

ISSUE_CLASSIFIER_PROMPT = """æ‚¨æ˜¯ä¸€åå®¢æˆ·æ”¯æŒä»£ç†ï¼Œæ­£åœ¨å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜ã€‚

å½“å‰é˜¶æ®µï¼šé—®é¢˜åˆ†ç±»
å®¢æˆ·ä¿¡æ¯ï¼šä¿ä¿®çŠ¶æ€ä¸º {warranty_status}

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. è¯·å®¢æˆ·æè¿°ä»–ä»¬çš„é—®é¢˜
2. ç¡®å®šæ˜¯ç¡¬ä»¶é—®é¢˜ï¼ˆç‰©ç†æŸåã€éƒ¨ä»¶æ•…éšœï¼‰è¿˜æ˜¯è½¯ä»¶é—®é¢˜ï¼ˆåº”ç”¨å´©æºƒã€æ€§èƒ½é—®é¢˜ï¼‰
3. ä½¿ç”¨ record_issue_type è®°å½•åˆ†ç±»å¹¶è¿›å…¥ä¸‹ä¸€æ­¥

å¦‚æœä¸æ˜ç¡®ï¼Œè¯·åœ¨åˆ†ç±»å‰æå‡ºæ¾„æ¸…æ€§é—®é¢˜ã€‚"""

RESOLUTION_SPECIALIST_PROMPT = """æ‚¨æ˜¯ä¸€åå®¢æˆ·æ”¯æŒä»£ç†ï¼Œæ­£åœ¨å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜ã€‚

å½“å‰é˜¶æ®µï¼šè§£å†³æ–¹æ¡ˆ
å®¢æˆ·ä¿¡æ¯ï¼šä¿ä¿®çŠ¶æ€ä¸º {warranty_status}ï¼Œé—®é¢˜ç±»å‹ä¸º {issue_type}

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. å¯¹äºè½¯ä»¶é—®é¢˜ï¼šä½¿ç”¨ provide_solution æä¾›æ•…éšœæ’é™¤æ­¥éª¤
2. å¯¹äºç¡¬ä»¶é—®é¢˜ï¼š
   - å¦‚æœåœ¨ä¿ä¿®æœŸå†…ï¼šä½¿ç”¨ provide_solution è§£é‡Šä¿ä¿®ç»´ä¿®æµç¨‹
   - å¦‚æœè¶…å‡ºä¿ä¿®æœŸï¼šä½¿ç”¨ escalate_to_human å¯»æ±‚ä»˜è´¹ç»´ä¿®é€‰é¡¹

åœ¨è§£å†³æ–¹æ¡ˆä¸­è¦å…·ä½“ä¸”ä¹äºåŠ©äººã€‚"""
```
:::

:::js
```typescript
// å°†æç¤ºå®šä¹‰ä¸ºå¸¸é‡ä»¥ä¾¿å¼•ç”¨
const WARRANTY_COLLECTOR_PROMPT = `æ‚¨æ˜¯ä¸€ä½å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜çš„å®¢æˆ·æ”¯æŒä»£ç†ã€‚

å½“å‰é˜¶æ®µï¼šä¿ä¿®éªŒè¯

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. çƒ­æƒ…é—®å€™å®¢æˆ·
2. è¯¢é—®ä»–ä»¬çš„è®¾å¤‡æ˜¯å¦åœ¨ä¿ä¿®æœŸå†…
3. ä½¿ç”¨ record_warranty_status è®°å½•ä»–ä»¬çš„å›ç­”å¹¶è¿›å…¥ä¸‹ä¸€æ­¥

ä¿æŒå¯¹è¯æ€§å’Œå‹å¥½æ€§ã€‚ä¸è¦ä¸€æ¬¡æ€§æå‡ºå¤šä¸ªé—®é¢˜ã€‚`;

const ISSUE_CLASSIFIER_PROMPT = `æ‚¨æ˜¯ä¸€ä½å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜çš„å®¢æˆ·æ”¯æŒä»£ç†ã€‚

å½“å‰é˜¶æ®µï¼šé—®é¢˜åˆ†ç±»
å®¢æˆ·ä¿¡æ¯ï¼šä¿ä¿®çŠ¶æ€ä¸º {warranty_status}

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. è¯·å®¢æˆ·æè¿°ä»–ä»¬çš„é—®é¢˜
2. åˆ¤æ–­æ˜¯ç¡¬ä»¶é—®é¢˜ï¼ˆç‰©ç†æŸåã€éƒ¨ä»¶æ•…éšœï¼‰è¿˜æ˜¯è½¯ä»¶é—®é¢˜ï¼ˆåº”ç”¨å´©æºƒã€æ€§èƒ½é—®é¢˜ï¼‰
3. ä½¿ç”¨ record_issue_type è®°å½•åˆ†ç±»å¹¶è¿›å…¥ä¸‹ä¸€æ­¥

å¦‚æœä¸æ˜ç¡®ï¼Œè¯·åœ¨åˆ†ç±»å‰æå‡ºæ¾„æ¸…æ€§é—®é¢˜ã€‚`;

const RESOLUTION_SPECIALIST_PROMPT = `æ‚¨æ˜¯ä¸€ä½å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜çš„å®¢æˆ·æ”¯æŒä»£ç†ã€‚

å½“å‰é˜¶æ®µï¼šè§£å†³æ–¹æ¡ˆ
å®¢æˆ·ä¿¡æ¯ï¼šä¿ä¿®çŠ¶æ€ä¸º {warranty_status}ï¼Œé—®é¢˜ç±»å‹ä¸º {issue_type}

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. å¯¹äºè½¯ä»¶é—®é¢˜ï¼šä½¿ç”¨ provide_solution æä¾›æ•…éšœæ’é™¤æ­¥éª¤
2. å¯¹äºç¡¬ä»¶é—®é¢˜ï¼š
   - å¦‚æœåœ¨ä¿ä¿®æœŸå†…ï¼šä½¿ç”¨ provide_solution è§£é‡Šä¿ä¿®ç»´ä¿®æµç¨‹
   - å¦‚æœè¶…å‡ºä¿ä¿®æœŸï¼šä½¿ç”¨ escalate_to_human è½¬æ¥äººå·¥å¤„ç†ä»˜è´¹ç»´ä¿®é€‰é¡¹

åœ¨è§£å†³æ–¹æ¡ˆä¸­è¦å…·ä½“ä¸”æœ‰ç”¨ã€‚`;
```
:::

</Accordion>

ç„¶åä½¿ç”¨å­—å…¸å°†æ­¥éª¤åç§°æ˜ å°„åˆ°å…¶é…ç½®ï¼š

:::python
```python
# æ­¥éª¤é…ç½®ï¼šå°†æ­¥éª¤åç§°æ˜ å°„åˆ°ï¼ˆæç¤ºã€å·¥å…·ã€æ‰€éœ€çŠ¶æ€ï¼‰
STEP_CONFIG = {
    "warranty_collector": {
        "prompt": WARRANTY_COLLECTOR_PROMPT,
        "tools": [record_warranty_status],
        "requires": [],
    },
    "issue_classifier": {
        "prompt": ISSUE_CLASSIFIER_PROMPT,
        "tools": [record_issue_type],
        "requires": ["warranty_status"],
    },
    "resolution_specialist": {
        "prompt": RESOLUTION_SPECIALIST_PROMPT,
        "tools": [provide_solution, escalate_to_human],
        "requires": ["warranty_status", "issue_type"],
    },
}
```
:::

:::js
```typescript
// æ­¥éª¤é…ç½®ï¼šå°†æ­¥éª¤åç§°æ˜ å°„åˆ°ï¼ˆæç¤ºã€å·¥å…·ã€æ‰€éœ€çŠ¶æ€ï¼‰
const STEP_CONFIG = {
  warranty_collector: {
    prompt: WARRANTY_COLLECTOR_PROMPT,
    tools: [recordWarrantyStatus],
    requires: [],
  },
  issue_classifier: {
    prompt: ISSUE_CLASSIFIER_PROMPT,
    tools: [recordIssueType],
    requires: ["warrantyStatus"],
  },
  resolution_specialist: {
    prompt: RESOLUTION_SPECIALIST_PROMPT,
    tools: [provideSolution, escalateToHuman],
    requires: ["warrantyStatus", "issueType"],
  },
} as const;
```
:::

è¿™ç§åŸºäºå­—å…¸çš„é…ç½®ä½¿å¾—ï¼š
- ä¸€ç›®äº†ç„¶åœ°æŸ¥çœ‹æ‰€æœ‰æ­¥éª¤
- è½»æ¾æ·»åŠ æ–°æ­¥éª¤ï¼ˆåªéœ€æ·»åŠ å¦ä¸€ä¸ªæ¡ç›®ï¼‰
- ç†è§£å·¥ä½œæµä¾èµ–å…³ç³»ï¼ˆ`requires` å­—æ®µï¼‰
- ä½¿ç”¨å¸¦æœ‰çŠ¶æ€å˜é‡çš„æç¤ºæ¨¡æ¿ï¼ˆä¾‹å¦‚ `{warranty_status}`ï¼‰

## 4. åˆ›å»ºåŸºäºæ­¥éª¤çš„ä¸­é—´ä»¶

åˆ›å»ºä»çŠ¶æ€ä¸­è¯»å– `current_step` å¹¶åº”ç”¨ç›¸åº”é…ç½®çš„ä¸­é—´ä»¶ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ `@wrap_model_call` è£…é¥°å™¨æ¥å®ç°ä¸€ä¸ªç®€æ´çš„å®ç°ï¼š

:::python
```python
from langchain.agents.middleware import wrap_model_call, ModelRequest, ModelResponse
from typing import Callable


@wrap_model_call  # [!code highlight]
def apply_step_config(
    request: ModelRequest,
    handler: Callable[[ModelRequest], ModelResponse],
) -> ModelResponse:
    """æ ¹æ®å½“å‰æ­¥éª¤é…ç½®ä»£ç†è¡Œä¸ºã€‚"""
    # è·å–å½“å‰æ­¥éª¤ï¼ˆé¦–æ¬¡äº¤äº’é»˜è®¤ä¸º warranty_collectorï¼‰
    current_step = request.state.get("current_step", "warranty_collector")  # [!code highlight]

    # æŸ¥æ‰¾æ­¥éª¤é…ç½®
    stage_config = STEP_CONFIG[current_step]  # [!code highlight]
```

# éªŒè¯å¿…éœ€çŠ¶æ€æ˜¯å¦å­˜åœ¨
    for key in stage_config["requires"]:
        if request.state.get(key) is None:
            raise ValueError(f"{key} must be set before reaching {current_step}")

    # ä½¿ç”¨çŠ¶æ€å€¼æ ¼å¼åŒ–æç¤ºï¼ˆæ”¯æŒ {warranty_status}ã€{issue_type} ç­‰ï¼‰
    system_prompt = stage_config["prompt"].format(**request.state)

    # æ³¨å…¥ç³»ç»Ÿæç¤ºå’Œæ­¥éª¤ç‰¹å®šå·¥å…·
    request = request.override(  # [!code highlight]
        system_prompt=system_prompt,  # [!code highlight]
        tools=stage_config["tools"],  # [!code highlight]
    )

    return handler(request)
```
:::

:::js
```typescript
import { createMiddleware } from "langchain";

const applyStepMiddleware = createMiddleware({
  name: "applyStep",
  stateSchema: SupportStateSchema,
  wrapModelCall: async (request, handler) => {
    // è·å–å½“å‰æ­¥éª¤ï¼ˆé¦–æ¬¡äº¤äº’é»˜è®¤ä¸º warranty_collectorï¼‰
    const currentStep = request.state.currentStep ?? "warranty_collector"; // [!code highlight]

    // æŸ¥æ‰¾æ­¥éª¤é…ç½®
    const stepConfig = STEP_CONFIG[currentStep]; // [!code highlight]

    // éªŒè¯å¿…éœ€çŠ¶æ€æ˜¯å¦å­˜åœ¨
    for (const key of stepConfig.requires) {
      if (request.state[key] === undefined) {
        throw new Error(`${key} must be set before reaching ${currentStep}`);
      }
    }

    // ä½¿ç”¨çŠ¶æ€å€¼æ ¼å¼åŒ–æç¤ºï¼ˆæ”¯æŒ {warrantyStatus}ã€{issueType} ç­‰ï¼‰
    let systemPrompt: string = stepConfig.prompt;
    for (const [key, value] of Object.entries(request.state)) {
      systemPrompt = systemPrompt.replace(`{${key}}`, String(value ?? ""));
    }

    // æ³¨å…¥ç³»ç»Ÿæç¤ºå’Œæ­¥éª¤ç‰¹å®šå·¥å…·
    return handler({
      ...request, // [!code highlight]
      systemPrompt, // [!code highlight]
      tools: [...stepConfig.tools], // [!code highlight]
    });
  },
});
```
:::

æ­¤ä¸­é—´ä»¶ï¼š

1.  **è¯»å–å½“å‰æ­¥éª¤**ï¼šä»çŠ¶æ€ä¸­è·å– `current_step`ï¼ˆé»˜è®¤ä¸º "warranty_collector"ï¼‰ã€‚
2.  **æŸ¥æ‰¾é…ç½®**ï¼šåœ¨ `STEP_CONFIG` ä¸­æ‰¾åˆ°åŒ¹é…çš„æ¡ç›®ã€‚
3.  **éªŒè¯ä¾èµ–é¡¹**ï¼šç¡®ä¿å¿…éœ€çš„çŠ¶æ€å­—æ®µå­˜åœ¨ã€‚
4.  **æ ¼å¼åŒ–æç¤º**ï¼šå°†çŠ¶æ€å€¼æ³¨å…¥åˆ°æç¤ºæ¨¡æ¿ä¸­ã€‚
5.  **åº”ç”¨é…ç½®**ï¼šè¦†ç›–ç³»ç»Ÿæç¤ºå’Œå¯ç”¨å·¥å…·ã€‚

`request.override()` æ–¹æ³•æ˜¯å…³é”®â€”â€”å®ƒå…è®¸æˆ‘ä»¬æ ¹æ®çŠ¶æ€åŠ¨æ€æ›´æ”¹æ™ºèƒ½ä½“çš„è¡Œä¸ºï¼Œè€Œæ— éœ€åˆ›å»ºå•ç‹¬çš„æ™ºèƒ½ä½“å®ä¾‹ã€‚

## 5. åˆ›å»ºæ™ºèƒ½ä½“

ç°åœ¨ï¼Œä½¿ç”¨åŸºäºæ­¥éª¤çš„ä¸­é—´ä»¶å’Œç”¨äºçŠ¶æ€æŒä¹…åŒ–çš„æ£€æŸ¥ç‚¹åˆ›å»ºæ™ºèƒ½ä½“ï¼š

:::python
```python
from langchain.agents import create_agent
from langgraph.checkpoint.memory import InMemorySaver

# ä»æ‰€æœ‰æ­¥éª¤é…ç½®ä¸­æ”¶é›†æ‰€æœ‰å·¥å…·
all_tools = [
    record_warranty_status,
    record_issue_type,
    provide_solution,
    escalate_to_human,
]

# ä½¿ç”¨åŸºäºæ­¥éª¤çš„é…ç½®åˆ›å»ºæ™ºèƒ½ä½“
agent = create_agent(
    model,
    tools=all_tools,
    state_schema=SupportState,  # [!code highlight]
    middleware=[apply_step_config],  # [!code highlight]
    checkpointer=InMemorySaver(),  # [!code highlight]
)
```
:::

:::js
```typescript
import { createAgent } from "langchain";
import { MemorySaver } from "@langchain/langgraph";
import { ChatOpenAI } from "@langchain/openai";

// ä»æ‰€æœ‰æ­¥éª¤é…ç½®ä¸­æ”¶é›†æ‰€æœ‰å·¥å…·
const allTools = [
  recordWarrantyStatus,
  recordIssueType,
  provideSolution,
  escalateToHuman,
];

// åˆå§‹åŒ–æ¨¡å‹
const model = new ChatOpenAI({
  model: "gpt-5o-mini",
  temperature: 0.7,
});

// ä½¿ç”¨åŸºäºæ­¥éª¤çš„é…ç½®åˆ›å»ºæ™ºèƒ½ä½“
const agent = createAgent({
  model,
  tools: allTools,
  stateSchema: SupportStateSchema,  // [!code highlight]
  middleware: [applyStepMiddleware],  // [!code highlight]
  checkpointer: new MemorySaver(),  // [!code highlight]
});
```

<Note>
**ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ç‚¹ï¼Ÿ** æ£€æŸ¥ç‚¹ï¼ˆcheckpointerï¼‰åœ¨å¯¹è¯è½®æ¬¡é—´ç»´æŠ¤çŠ¶æ€ã€‚æ²¡æœ‰å®ƒï¼Œ`current_step` çŠ¶æ€ä¼šåœ¨ç”¨æˆ·æ¶ˆæ¯ä¹‹é—´ä¸¢å¤±ï¼Œä»è€Œç ´åå·¥ä½œæµã€‚
</Note>

## 6. æµ‹è¯•å·¥ä½œæµ

æµ‹è¯•å®Œæ•´çš„å·¥ä½œæµï¼š

:::python
```python
from langchain.messages import HumanMessage
import uuid

# Configuration for this conversation thread
thread_id = str(uuid.uuid4())
config = {"configurable": {"thread_id": thread_id}}

# Turn 1: Initial message - starts with warranty_collector step
print("=== Turn 1: Warranty Collection ===")
result = agent.invoke(
    {"messages": [HumanMessage("Hi, my phone screen is cracked")]},
    config
)
for msg in result['messages']:
    msg.pretty_print()

# Turn 2: User responds about warranty
print("\n=== Turn 2: Warranty Response ===")
result = agent.invoke(
    {"messages": [HumanMessage("Yes, it's still under warranty")]},
    config
)
for msg in result['messages']:
    msg.pretty_print()
print(f"Current step: {result.get('current_step')}")

# Turn 3: User describes the issue
print("\n=== Turn 3: Issue Description ===")
result = agent.invoke(
    {"messages": [HumanMessage("The screen is physically cracked from dropping it")]},
    config
)
for msg in result['messages']:
    msg.pretty_print()
print(f"Current step: {result.get('current_step')}")

# Turn 4: Resolution
print("\n=== Turn 4: Resolution ===")
result = agent.invoke(
    {"messages": [HumanMessage("What should I do?")]},
    config
)
for msg in result['messages']:
    msg.pretty_print()
```
:::

:::js
```typescript
import { HumanMessage } from "@langchain/core/messages";
import { v4 as uuidv4 } from "uuid";

// Configuration for this conversation thread
const threadId = uuidv4();
const config = { configurable: { thread_id: threadId } };

// Turn 1: Initial message - starts with warranty_collector step
console.log("=== Turn 1: Warranty Collection ===");
let result = await agent.invoke(
  { messages: [new HumanMessage("Hi, my phone screen is cracked")] },
  config
);
for (const msg of result.messages) {
  console.log(msg.content);
}

// Turn 2: User responds about warranty
console.log("\n=== Turn 2: Warranty Response ===");
result = await agent.invoke(
  { messages: [new HumanMessage("Yes, it's still under warranty")] },
  config
);
for (const msg of result.messages) {
  console.log(msg.content);
}
console.log(`Current step: ${result.currentStep}`);

// Turn 3: User describes the issue
console.log("\n=== Turn 3: Issue Description ===");
result = await agent.invoke(
  { messages: [new HumanMessage("The screen is physically cracked from dropping it")] },
  config
);
for (const msg of result.messages) {
  console.log(msg.content);
}
console.log(`Current step: ${result.currentStep}`);

// Turn 4: Resolution
console.log("\n=== Turn 4: Resolution ===");
result = await agent.invoke(
  { messages: [new HumanMessage("What should I do?")] },
  config
);
for (const msg of result.messages) {
  console.log(msg.content);
}
```
:::

é¢„æœŸæµç¨‹ï¼š
1.  **ä¿ä¿®éªŒè¯æ­¥éª¤**ï¼šè¯¢é—®ä¿ä¿®çŠ¶æ€
2.  **é—®é¢˜åˆ†ç±»æ­¥éª¤**ï¼šè¯¢é—®é—®é¢˜è¯¦æƒ…ï¼Œç¡®å®šä¸ºç¡¬ä»¶é—®é¢˜
3.  **è§£å†³æ–¹æ¡ˆæ­¥éª¤**ï¼šæä¾›ä¿ä¿®ç»´ä¿®æŒ‡å¯¼

## 7. ç†è§£çŠ¶æ€è½¬æ¢

è®©æˆ‘ä»¬è¿½è¸ªæ¯ä¸€è½®å‘ç”Ÿäº†ä»€ä¹ˆï¼š

### ç¬¬ 1 è½®ï¼šåˆå§‹æ¶ˆæ¯

:::python
```python
{
    "messages": [HumanMessage("Hi, my phone screen is cracked")],
    "current_step": "warranty_collector"  # Default value
}
```
:::

:::js
```typescript
{
  messages: [new HumanMessage("Hi, my phone screen is cracked")],
  currentStep: "warranty_collector"  // Default value
}
```
:::

ä¸­é—´ä»¶åº”ç”¨ï¼š
- ç³»ç»Ÿæç¤ºï¼š`WARRANTY_COLLECTOR_PROMPT`
- å·¥å…·ï¼š`[record_warranty_status]`

### ç¬¬ 2 è½®ï¼šè®°å½•ä¿ä¿®çŠ¶æ€å

:::python
å·¥å…·è°ƒç”¨ï¼š`record_warranty_status("in_warranty")` è¿”å›ï¼š
```python
Command(update={
    "warranty_status": "in_warranty",
    "current_step": "issue_classifier"  # State transition!
})
```
:::

:::js
å·¥å…·è°ƒç”¨ï¼š`recordWarrantyStatus("in_warranty")` è¿”å›ï¼š
```typescript
new Command({
  update: {
    warrantyStatus: "in_warranty",
    currentStep: "issue_classifier"  // çŠ¶æ€è½¬æ¢ï¼
  }
})
```
:::

ä¸‹ä¸€è½®ï¼Œä¸­é—´ä»¶åº”ç”¨ï¼š
- ç³»ç»Ÿæç¤ºï¼š`ISSUE_CLASSIFIER_PROMPT`ï¼ˆä½¿ç”¨ `warranty_status="in_warranty"` æ ¼å¼åŒ–ï¼‰
- å·¥å…·ï¼š`[record_issue_type]`

### ç¬¬ 3 è½®ï¼šé—®é¢˜åˆ†ç±»å

:::python
å·¥å…·è°ƒç”¨ï¼š`record_issue_type("hardware")` è¿”å›ï¼š
```python
Command(update={
    "issue_type": "hardware",
    "current_step": "resolution_specialist"  # çŠ¶æ€è½¬æ¢ï¼
})
```
:::

:::js
å·¥å…·è°ƒç”¨ï¼š`recordIssueType("hardware")` è¿”å›ï¼š
```typescript
new Command({
  update: {
    issueType: "hardware",
    currentStep: "resolution_specialist"  // çŠ¶æ€è½¬æ¢ï¼
  }
})
```
:::

ä¸‹ä¸€è½®ï¼Œä¸­é—´ä»¶åº”ç”¨ï¼š
- ç³»ç»Ÿæç¤ºï¼š`RESOLUTION_SPECIALIST_PROMPT`ï¼ˆä½¿ç”¨ `warranty_status` å’Œ `issue_type` æ ¼å¼åŒ–ï¼‰
- å·¥å…·ï¼š`[provide_solution, escalate_to_human]`

å…³é”®æ´å¯Ÿï¼š**å·¥å…·é€šè¿‡æ›´æ–° `current_step` æ¥é©±åŠ¨å·¥ä½œæµ**ï¼Œè€Œ**ä¸­é—´ä»¶é€šè¿‡åœ¨ä¸‹è½®åº”ç”¨é€‚å½“çš„é…ç½®æ¥å“åº”**ã€‚

## 8. ç®¡ç†æ¶ˆæ¯å†å²

éšç€æ™ºèƒ½ä½“ï¼ˆagentï¼‰é€æ­¥æ¨è¿›ï¼Œæ¶ˆæ¯å†å²ä¼šå¢é•¿ã€‚ä½¿ç”¨[æ‘˜è¦ä¸­é—´ä»¶](/oss/langchain/short-term-memory#summarize-messages)æ¥å‹ç¼©è¾ƒæ—©çš„æ¶ˆæ¯ï¼ŒåŒæ—¶ä¿ç•™å¯¹è¯ä¸Šä¸‹æ–‡ï¼š

:::python
```python
from langchain.agents import create_agent
from langchain.agents.middleware import SummarizationMiddleware  # [!code highlight]
from langgraph.checkpoint.memory import InMemorySaver

agent = create_agent(
    model,
    tools=all_tools,
    state_schema=SupportState,
    middleware=[
        apply_step_config,
        SummarizationMiddleware(  # [!code highlight]
            model="gpt-4o-mini",
            trigger=("tokens", 4000),
            keep=("messages", 10)
        )
    ],
    checkpointer=InMemorySaver(),
)
```
:::

:::js
```typescript
import { createAgent, SummarizationMiddleware } from "langchain";  // [!code highlight]
import { MemorySaver } from "@langchain/langgraph";

const agent = createAgent({
  model,
  tools: allTools,
  stateSchema: SupportStateSchema,
  middleware: [
    applyStepMiddleware,
    new SummarizationMiddleware({  // [!code highlight]
      model: "gpt-4o-mini",
      trigger: { tokens: 4000 },
      keep: { messages: 10 },
    }),
  ],
  checkpointer: new MemorySaver(),
});
```
:::

æœ‰å…³å…¶ä»–è®°å¿†ï¼ˆmemoryï¼‰ç®¡ç†æŠ€æœ¯ï¼Œè¯·å‚é˜…[çŸ­æœŸè®°å¿†æŒ‡å—](/oss/langchain/short-term-memory)ã€‚

## 9. å¢åŠ çµæ´»æ€§ï¼šè¿”å›

æŸäº›å·¥ä½œæµéœ€è¦å…è®¸ç”¨æˆ·è¿”å›ä¹‹å‰çš„æ­¥éª¤ä»¥æ›´æ­£ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œæ›´æ”¹ä¿ä¿®çŠ¶æ€æˆ–é—®é¢˜åˆ†ç±»ï¼‰ã€‚ç„¶è€Œï¼Œå¹¶éæ‰€æœ‰è½¬æ¢éƒ½æœ‰æ„ä¹‰â€”â€”ä¾‹å¦‚ï¼Œä¸€æ—¦é€€æ¬¾å·²å¤„ç†ï¼Œé€šå¸¸æ— æ³•è¿”å›ã€‚å¯¹äºè¿™ä¸ªæ”¯æŒå·¥ä½œæµï¼Œæˆ‘ä»¬å°†æ·»åŠ å·¥å…·ä»¥è¿”å›åˆ°ä¿ä¿®éªŒè¯å’Œé—®é¢˜åˆ†ç±»æ­¥éª¤ã€‚

<Tip>
å¦‚æœä½ çš„å·¥ä½œæµéœ€è¦åœ¨å¤§å¤šæ•°æ­¥éª¤ä¹‹é—´è¿›è¡Œä»»æ„è½¬æ¢ï¼Œè¯·è€ƒè™‘ä½ æ˜¯å¦çœŸçš„éœ€è¦ä¸€ä¸ªç»“æ„åŒ–çš„å·¥ä½œæµã€‚è¿™ç§æ¨¡å¼åœ¨æ­¥éª¤éµå¾ªæ¸…æ™°çš„é¡ºåºè¿›å±•ã€å¶å°”éœ€è¦å‘åè½¬æ¢ä»¥è¿›è¡Œæ›´æ­£æ—¶æ•ˆæœæœ€ä½³ã€‚
</Tip>

å‘è§£å†³æ­¥éª¤æ·»åŠ â€œè¿”å›â€å·¥å…·ï¼š

:::python
```python
@tool
def go_back_to_warranty() -> Command:  # [!code highlight]
    """è¿”å›ä¿ä¿®éªŒè¯æ­¥éª¤ã€‚"""
    return Command(update={"current_step": "warranty_collector"})  # [!code highlight]


@tool
def go_back_to_classification() -> Command:  # [!code highlight]
    """è¿”å›é—®é¢˜åˆ†ç±»æ­¥éª¤ã€‚"""
    return Command(update={"current_step": "issue_classifier"})  # [!code highlight]


# æ›´æ–° resolution_specialist é…ç½®ä»¥åŒ…å«è¿™äº›å·¥å…·
STEP_CONFIG["resolution_specialist"]["tools"].extend([
    go_back_to_warranty,
    go_back_to_classification
])
```
:::

:::js
```typescript
import { tool } from "langchain";
import { Command } from "@langchain/langgraph";
import { z } from "zod";

const goBackToWarranty = tool(  // [!code highlight]
  async () => {
    return new Command({ update: { currentStep: "warranty_collector" } });  // [!code highlight]
  },
  {
    name: "go_back_to_warranty",
    description: "Go back to warranty verification step.",
    schema: z.object({}),
  }
);

const goBackToClassification = tool(  // [!code highlight]
  async () => {
    return new Command({ update: { currentStep: "issue_classifier" } });  // [!code highlight]
  },
  {
    name: "go_back_to_classification",
    description: "Go back to issue classification step.",
    schema: z.object({}),
  }
);

// Update the resolution_specialist configuration to include these tools
STEP_CONFIG.resolution_specialist.tools.push(
  goBackToWarranty,
  goBackToClassification
);
```
:::

æ›´æ–°è§£å†³æ–¹æ¡ˆä¸“å®¶çš„æç¤ºè¯ï¼ŒæåŠè¿™äº›å·¥å…·ï¼š

:::python
```python
RESOLUTION_SPECIALIST_PROMPT = """You are a customer support agent helping with device issues.

CURRENT STAGE: Resolution
CUSTOMER INFO: Warranty status is {warranty_status}, issue type is {issue_type}

At this step, you need to:
1. For SOFTWARE issues: provide troubleshooting steps using provide_solution
2. For HARDWARE issues:
   - If IN WARRANTY: explain warranty repair process using provide_solution
   - If OUT OF WARRANTY: escalate_to_human for paid repair options

If the customer indicates any information was wrong, use:
- go_back_to_warranty to correct warranty status
- go_back_to_classification to correct issue type

Be specific and helpful in your solutions."""
```
:::

:::js
```typescript
const RESOLUTION_SPECIALIST_PROMPT = `You are a customer support agent helping with device issues.

CURRENT STAGE: Resolution
CUSTOMER INFO: Warranty status is {warrantyStatus}, issue type is {issueType}

At this step, you need to:
1. For SOFTWARE issues: provide troubleshooting steps using provide_solution
2. For HARDWARE issues:
   - If IN WARRANTY: explain warranty repair process using provide_solution
   - If OUT OF WARRANTY: escalate_to_human for paid repair options

If the customer indicates any information was wrong, use:
- go_back_to_warranty to correct warranty status
- go_back_to_classification to correct issue type

Be specific and helpful in your solutions.`;
```
:::

ç°åœ¨æ™ºèƒ½ä½“å¯ä»¥å¤„ç†æ›´æ­£äº†ï¼š

:::python
```python
result = agent.invoke(
    {"messages": [HumanMessage("Actually, I made a mistake - my device is out of warranty")]},
    config
)
# Agent will call go_back_to_warranty and restart the warranty verification step
```
:::

:::js
```typescript
const result = await agent.invoke(
  { messages: [new HumanMessage("Actually, I made a mistake - my device is out of warranty")] },
  config
);
// Agent will call go_back_to_warranty and restart the warranty verification step
```
:::

## å®Œæ•´ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¯è¿è¡Œè„šæœ¬ä¸­çš„æ‰€æœ‰å†…å®¹ï¼š

<Expandable title="Complete code" defaultOpen={false}>
:::python
```python
"""
Customer Support State Machine Example

This example demonstrates the state machine pattern.
A single agent dynamically changes its behavior based on the current_step state,
creating a state machine for sequential information collection.
"""

import uuid

from langgraph.checkpoint.memory import InMemorySaver
from langgraph.types import Command
from typing import Callable, Literal
from typing_extensions import NotRequired

from langchain.agents import AgentState, create_agent
from langchain.agents.middleware import wrap_model_call, ModelRequest, ModelResponse, SummarizationMiddleware
from langchain.chat_models import init_chat_model
from langchain.messages import HumanMessage, ToolMessage
from langchain.tools import tool, ToolRuntime

model = init_chat_model("anthropic:claude-3-5-sonnet-latest")

# å®šä¹‰å¯èƒ½çš„å·¥ä½œæµæ­¥éª¤
SupportStep = Literal["warranty_collector", "issue_classifier", "resolution_specialist"]


class SupportState(AgentState):
    """å®¢æˆ·æ”¯æŒå·¥ä½œæµçš„çŠ¶æ€ã€‚"""

    current_step: NotRequired[SupportStep]
    warranty_status: NotRequired[Literal["in_warranty", "out_of_warranty"]]
    issue_type: NotRequired[Literal["hardware", "software"]]


@tool
def record_warranty_status(
    status: Literal["in_warranty", "out_of_warranty"],
    runtime: ToolRuntime[None, SupportState],
) -> Command:
    """è®°å½•å®¢æˆ·çš„ä¿ä¿®çŠ¶æ€å¹¶è¿‡æ¸¡åˆ°é—®é¢˜åˆ†ç±»æ­¥éª¤ã€‚"""
    return Command(
        update={
            "messages": [
                ToolMessage(
                    content=f"ä¿ä¿®çŠ¶æ€å·²è®°å½•ä¸º: {status}",
                    tool_call_id=runtime.tool_call_id,
                )
            ],
            "warranty_status": status,
            "current_step": "issue_classifier",
        }
    )


@tool
def record_issue_type(
    issue_type: Literal["hardware", "software"],
    runtime: ToolRuntime[None, SupportState],
) -> Command:
    """è®°å½•é—®é¢˜ç±»å‹å¹¶è¿‡æ¸¡åˆ°è§£å†³æ–¹æ¡ˆä¸“å®¶æ­¥éª¤ã€‚"""
    return Command(
        update={
            "messages": [
                ToolMessage(
                    content=f"é—®é¢˜ç±»å‹å·²è®°å½•ä¸º: {issue_type}",
                    tool_call_id=runtime.tool_call_id,
                )
            ],
            "issue_type": issue_type,
            "current_step": "resolution_specialist",
        }
    )


@tool
def escalate_to_human(reason: str) -> str:
    """å°†æ¡ˆä¾‹å‡çº§ç»™äººå·¥æ”¯æŒä¸“å‘˜ã€‚"""
    # åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œè¿™å°†åˆ›å»ºå·¥å•ã€é€šçŸ¥å·¥ä½œäººå‘˜ç­‰ã€‚
    return f"æ­£åœ¨å‡çº§ç»™äººå·¥æ”¯æŒã€‚åŸå› : {reason}"


@tool
def provide_solution(solution: str) -> str:
    """ä¸ºå®¢æˆ·çš„é—®é¢˜æä¾›è§£å†³æ–¹æ¡ˆã€‚"""
    return f"æä¾›çš„è§£å†³æ–¹æ¡ˆ: {solution}"


# å°†æç¤ºå®šä¹‰ä¸ºå¸¸é‡
WARRANTY_COLLECTOR_PROMPT = """æ‚¨æ˜¯ä¸€åå®¢æˆ·æ”¯æŒä»£ç†ï¼Œæ­£åœ¨å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜ã€‚

å½“å‰æ­¥éª¤: ä¿ä¿®éªŒè¯

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. çƒ­æƒ…é—®å€™å®¢æˆ·
2. è¯¢é—®ä»–ä»¬çš„è®¾å¤‡æ˜¯å¦åœ¨ä¿ä¿®æœŸå†…
3. ä½¿ç”¨ record_warranty_status è®°å½•ä»–ä»¬çš„å›ç­”å¹¶è¿›å…¥ä¸‹ä¸€æ­¥

è¯·ä¿æŒå¯¹è¯æ€§å’Œå‹å¥½ã€‚ä¸è¦ä¸€æ¬¡æ€§é—®å¤šä¸ªé—®é¢˜ã€‚"""

ISSUE_CLASSIFIER_PROMPT = """æ‚¨æ˜¯ä¸€åå®¢æˆ·æ”¯æŒä»£ç†ï¼Œæ­£åœ¨å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜ã€‚

å½“å‰æ­¥éª¤: é—®é¢˜åˆ†ç±»
å®¢æˆ·ä¿¡æ¯: ä¿ä¿®çŠ¶æ€ä¸º {warranty_status}

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. è¯·å®¢æˆ·æè¿°ä»–ä»¬çš„é—®é¢˜
2. åˆ¤æ–­æ˜¯ç¡¬ä»¶é—®é¢˜ï¼ˆç‰©ç†æŸåã€éƒ¨ä»¶æ•…éšœï¼‰è¿˜æ˜¯è½¯ä»¶é—®é¢˜ï¼ˆåº”ç”¨å´©æºƒã€æ€§èƒ½é—®é¢˜ï¼‰
3. ä½¿ç”¨ record_issue_type è®°å½•åˆ†ç±»å¹¶è¿›å…¥ä¸‹ä¸€æ­¥

å¦‚æœä¸æ˜ç¡®ï¼Œè¯·åœ¨åˆ†ç±»å‰è¯¢é—®æ¾„æ¸…æ€§é—®é¢˜ã€‚"""

RESOLUTION_SPECIALIST_PROMPT = """æ‚¨æ˜¯ä¸€åå®¢æˆ·æ”¯æŒä»£ç†ï¼Œæ­£åœ¨å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜ã€‚

å½“å‰æ­¥éª¤: è§£å†³æ–¹æ¡ˆ
å®¢æˆ·ä¿¡æ¯: ä¿ä¿®çŠ¶æ€ä¸º {warranty_status}ï¼Œé—®é¢˜ç±»å‹ä¸º {issue_type}

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. å¯¹äºè½¯ä»¶é—®é¢˜ï¼šä½¿ç”¨ provide_solution æä¾›æ•…éšœæ’é™¤æ­¥éª¤
2. å¯¹äºç¡¬ä»¶é—®é¢˜ï¼š
   - å¦‚æœåœ¨ä¿ä¿®æœŸå†…ï¼šä½¿ç”¨ provide_solution è§£é‡Šä¿ä¿®ç»´ä¿®æµç¨‹
   - å¦‚æœè¶…å‡ºä¿ä¿®æœŸï¼šä½¿ç”¨ escalate_to_human è·å–ä»˜è´¹ç»´ä¿®é€‰é¡¹

åœ¨æ‚¨çš„è§£å†³æ–¹æ¡ˆä¸­è¯·å…·ä½“ä¸”æä¾›å¸®åŠ©ã€‚"""


# æ­¥éª¤é…ç½®ï¼šå°†æ­¥éª¤åç§°æ˜ å°„åˆ° (æç¤º, å·¥å…·, æ‰€éœ€çŠ¶æ€)
STEP_CONFIG = {
    "warranty_collector": {
        "prompt": WARRANTY_COLLECTOR_PROMPT,
        "tools": [record_warranty_status],
        "requires": [],
    },
    "issue_classifier": {
        "prompt": ISSUE_CLASSIFIER_PROMPT,
        "tools": [record_issue_type],
        "requires": ["warranty_status"],
    },
    "resolution_specialist": {
        "prompt": RESOLUTION_SPECIALIST_PROMPT,
        "tools": [provide_solution, escalate_to_human],
        "requires": ["warranty_status", "issue_type"],
    },
}

@wrap_model_call
def apply_step_config(
    request: ModelRequest,
    handler: Callable[[ModelRequest], ModelResponse],
) -> ModelResponse:
    """æ ¹æ®å½“å‰æ­¥éª¤é…ç½®æ™ºèƒ½ä½“è¡Œä¸ºã€‚"""
    # è·å–å½“å‰æ­¥éª¤ï¼ˆé¦–æ¬¡äº¤äº’é»˜è®¤ä¸º warranty_collectorï¼‰
    current_step = request.state.get("current_step", "warranty_collector")

    # æŸ¥æ‰¾æ­¥éª¤é…ç½®
    step_config = STEP_CONFIG[current_step]

    # éªŒè¯æ‰€éœ€çŠ¶æ€æ˜¯å¦å­˜åœ¨
    for key in step_config["requires"]:
        if request.state.get(key) is None:
            raise ValueError(f"åœ¨åˆ°è¾¾ {current_step} ä¹‹å‰å¿…é¡»è®¾ç½® {key}")

    # ä½¿ç”¨çŠ¶æ€å€¼æ ¼å¼åŒ–æç¤ºè¯
    system_prompt = step_config["prompt"].format(**request.state)

    # æ³¨å…¥ç³»ç»Ÿæç¤ºè¯å’Œæ­¥éª¤ç‰¹å®šå·¥å…·
    request = request.override(
        system_prompt=system_prompt,
        tools=step_config["tools"],
    )

    return handler(request)


# ä»æ‰€æœ‰æ­¥éª¤é…ç½®ä¸­æ”¶é›†æ‰€æœ‰å·¥å…·
all_tools = [
    record_warranty_status,
    record_issue_type,
    provide_solution,
    escalate_to_human,
]

# åˆ›å»ºå…·æœ‰åŸºäºæ­¥éª¤çš„é…ç½®å’Œæ‘˜è¦åŠŸèƒ½çš„æ™ºèƒ½ä½“
agent = create_agent(
    model,
    tools=all_tools,
    state_schema=SupportState,
    middleware=[
        apply_step_config,
        SummarizationMiddleware(
            model="gpt-4o-mini",
            trigger=("tokens", 4000),
            keep=("messages", 10)
        )
    ],
    checkpointer=InMemorySaver(),
)


# ============================================================================
# æµ‹è¯•å·¥ä½œæµ
# ============================================================================

if __name__ == "__main__":
    thread_id = str(uuid.uuid4())
    config = {"configurable": {"thread_id": thread_id}}

    result = agent.invoke(
        {"messages": [HumanMessage("Hi, my phone screen is cracked")]},
        config
    )

    result = agent.invoke(
        {"messages": [HumanMessage("Yes, it's still under warranty")]},
        config
    )

    result = agent.invoke(
        {"messages": [HumanMessage("The screen is physically cracked from dropping it")]},
        config
    )

    result = agent.invoke(
        {"messages": [HumanMessage("What should I do?")]},
        config
    )
    for msg in result['messages']:
        msg.pretty_print()
```
:::

:::js
```typescript
import { createMiddleware, createAgent } from "langchain";

import { z } from "zod";
import { v4 as uuidv4 } from "uuid";
import { tool, ToolMessage, type ToolRuntime, HumanMessage } from "langchain";
import { Command, MemorySaver } from "@langchain/langgraph";
import { ChatOpenAI } from "@langchain/openai";

// å®šä¹‰å¯èƒ½çš„å·¥ä½œæµæ­¥éª¤
const SupportStepSchema = z.enum([
  "warranty_collector",
  "issue_classifier",
  "resolution_specialist",
]);
const WarrantyStatusSchema = z.enum(["in_warranty", "out_of_warranty"]);
const IssueTypeSchema = z.enum(["hardware", "software"]);

// å®¢æˆ·æ”¯æŒå·¥ä½œæµçš„çŠ¶æ€
const SupportStateSchema = z.object({

  currentStep: SupportStepSchema.optional(),
  warrantyStatus: WarrantyStatusSchema.optional(),
  issueType: IssueTypeSchema.optional(),
});

const recordWarrantyStatus = tool(
  async (input, config: ToolRuntime<typeof SupportStateSchema>) => {
    return new Command({

      update: {

        messages: [
          new ToolMessage({
            content: `Warranty status recorded as: ${input.status}`,
            tool_call_id: config.toolCallId,
          }),
        ],
        warrantyStatus: input.status,
        currentStep: "issue_classifier",
      },
    });
  },
  {
    name: "record_warranty_status",
    description:
      "è®°å½•å®¢æˆ·çš„ä¿ä¿®çŠ¶æ€å¹¶è¿‡æ¸¡åˆ°é—®é¢˜åˆ†ç±»ã€‚",
    schema: z.object({
      status: WarrantyStatusSchema,
    }),
  }
);

const recordIssueType = tool(
  async (input, config: ToolRuntime<typeof SupportStateSchema>) => {
    return new Command({

      update: {

messages: [
          new ToolMessage({
            content: `é—®é¢˜ç±»å‹å·²è®°å½•ä¸ºï¼š${input.issueType}`,
            tool_call_id: config.toolCallId,
          }),
        ],
        issueType: input.issueType,
        currentStep: "resolution_specialist",
      },
    });
  },
  {
    name: "record_issue_type",
    description:
      "è®°å½•é—®é¢˜ç±»å‹å¹¶è½¬äº¤ç»™è§£å†³æ–¹æ¡ˆä¸“å®¶ã€‚",
    schema: z.object({
      issueType: IssueTypeSchema,
    }),
  }
);

const escalateToHuman = tool(
  async (input) => {
    // åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œè¿™é‡Œä¼šåˆ›å»ºå·¥å•ã€é€šçŸ¥å·¥ä½œäººå‘˜ç­‰ã€‚
    return `æ­£åœ¨å‡çº§è‡³äººå·¥æ”¯æŒã€‚åŸå› ï¼š${input.reason}`;
  },
  {
    name: "escalate_to_human",
    description: "å°†æ¡ˆä¾‹å‡çº§è‡³äººå·¥æ”¯æŒä¸“å®¶ã€‚",
    schema: z.object({
      reason: z.string(),
    }),
  }
);

const provideSolution = tool(
  async (input) => {
    return `æä¾›çš„è§£å†³æ–¹æ¡ˆï¼š${input.solution}`;
  },
  {
    name: "provide_solution",
    description: "ä¸ºå®¢æˆ·çš„é—®é¢˜æä¾›è§£å†³æ–¹æ¡ˆã€‚",
    schema: z.object({
      solution: z.string(),
    }),
  }
);

// å°†æç¤ºå®šä¹‰ä¸ºå¸¸é‡ä»¥ä¾¿å¼•ç”¨
const WARRANTY_COLLECTOR_PROMPT = `æ‚¨æ˜¯ä¸€ä½å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜çš„å®¢æˆ·æ”¯æŒä»£ç†ã€‚

å½“å‰é˜¶æ®µï¼šä¿ä¿®éªŒè¯

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. çƒ­æƒ…é—®å€™å®¢æˆ·
2. è¯¢é—®ä»–ä»¬çš„è®¾å¤‡æ˜¯å¦åœ¨ä¿ä¿®æœŸå†…
3. ä½¿ç”¨ record_warranty_status è®°å½•ä»–ä»¬çš„å›å¤å¹¶è¿›å…¥ä¸‹ä¸€æ­¥

ä¿æŒå¯¹è¯æ€§å’Œå‹å¥½æ€§ã€‚ä¸è¦ä¸€æ¬¡æ€§æå‡ºå¤šä¸ªé—®é¢˜ã€‚`;

const ISSUE_CLASSIFIER_PROMPT = `æ‚¨æ˜¯ä¸€ä½å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜çš„å®¢æˆ·æ”¯æŒä»£ç†ã€‚

å½“å‰é˜¶æ®µï¼šé—®é¢˜åˆ†ç±»
å®¢æˆ·ä¿¡æ¯ï¼šä¿ä¿®çŠ¶æ€ä¸º {warranty_status}

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. è¯·å®¢æˆ·æè¿°ä»–ä»¬çš„é—®é¢˜
2. åˆ¤æ–­æ˜¯ç¡¬ä»¶é—®é¢˜ï¼ˆç‰©ç†æŸåã€éƒ¨ä»¶æ•…éšœï¼‰è¿˜æ˜¯è½¯ä»¶é—®é¢˜ï¼ˆåº”ç”¨å´©æºƒã€æ€§èƒ½é—®é¢˜ï¼‰
3. ä½¿ç”¨ record_issue_type è®°å½•åˆ†ç±»å¹¶è¿›å…¥ä¸‹ä¸€æ­¥

å¦‚æœä¸æ˜ç¡®ï¼Œè¯·åœ¨åˆ†ç±»å‰æå‡ºæ¾„æ¸…æ€§é—®é¢˜ã€‚`;

const RESOLUTION_SPECIALIST_PROMPT = `æ‚¨æ˜¯ä¸€ä½å¸®åŠ©å¤„ç†è®¾å¤‡é—®é¢˜çš„å®¢æˆ·æ”¯æŒä»£ç†ã€‚

å½“å‰é˜¶æ®µï¼šè§£å†³æ–¹æ¡ˆ
å®¢æˆ·ä¿¡æ¯ï¼šä¿ä¿®çŠ¶æ€ä¸º {warranty_status}ï¼Œé—®é¢˜ç±»å‹ä¸º {issue_type}

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨éœ€è¦ï¼š
1. å¯¹äºè½¯ä»¶é—®é¢˜ï¼šä½¿ç”¨ provide_solution æä¾›æ•…éšœæ’é™¤æ­¥éª¤
2. å¯¹äºç¡¬ä»¶é—®é¢˜ï¼š
   - å¦‚æœåœ¨ä¿ä¿®æœŸå†…ï¼šä½¿ç”¨ provide_solution è§£é‡Šä¿ä¿®ç»´ä¿®æµç¨‹
   - å¦‚æœè¶…å‡ºä¿ä¿®æœŸï¼šä½¿ç”¨ escalate_to_human å¯»æ±‚ä»˜è´¹ç»´ä¿®é€‰é¡¹

åœ¨è§£å†³æ–¹æ¡ˆä¸­è¦å…·ä½“ä¸”æœ‰ç”¨ã€‚`;

// æ­¥éª¤é…ç½®ï¼šå°†æ­¥éª¤åç§°æ˜ å°„åˆ°ï¼ˆæç¤ºã€å·¥å…·ã€æ‰€éœ€çŠ¶æ€ï¼‰
const STEP_CONFIG = {
  warranty_collector: {
    prompt: WARRANTY_COLLECTOR_PROMPT,
    tools: [recordWarrantyStatus],
    requires: [],
  },
  issue_classifier: {
    prompt: ISSUE_CLASSIFIER_PROMPT,
    tools: [recordIssueType],
    requires: ["warrantyStatus"],
  },
  resolution_specialist: {
    prompt: RESOLUTION_SPECIALIST_PROMPT,
    tools: [provideSolution, escalateToHuman],
    requires: ["warrantyStatus", "issueType"],
  },
} as const;

const applyStepMiddleware = createMiddleware({
  name: "applyStep",
  stateSchema: SupportStateSchema,
  wrapModelCall: async (request, handler) => {
    // è·å–å½“å‰æ­¥éª¤ï¼ˆé¦–æ¬¡äº¤äº’é»˜è®¤ä¸º warranty_collectorï¼‰
    const currentStep = request.state.currentStep ?? "warranty_collector";

    // æŸ¥æ‰¾æ­¥éª¤é…ç½®
    const stepConfig = STEP_CONFIG[currentStep];

    // éªŒè¯æ‰€éœ€çŠ¶æ€æ˜¯å¦å­˜åœ¨
    for (const key of stepConfig.requires) {
      if (request.state[key] === undefined) {
        throw new Error(`åœ¨è¿›å…¥ ${currentStep} ä¹‹å‰å¿…é¡»è®¾ç½® ${key}`);
      }
    }

// ä½¿ç”¨çŠ¶æ€å€¼æ ¼å¼åŒ–æç¤ºï¼ˆæ”¯æŒ {warrantyStatus}ã€{issueType} ç­‰ï¼‰
    let systemPrompt: string = stepConfig.prompt;
    for (const [key, value] of Object.entries(request.state)) {
      systemPrompt = systemPrompt.replace(`{${key}}`, String(value ?? ""));
    }

    // æ³¨å…¥ç³»ç»Ÿæç¤ºå’Œæ­¥éª¤ç‰¹å®šå·¥å…·
    return handler({
      ...request,
      systemPrompt,
      tools: [...stepConfig.tools],
    });
  },
});

// ä»æ‰€æœ‰æ­¥éª¤é…ç½®ä¸­æ”¶é›†æ‰€æœ‰å·¥å…·
const allTools = [
  recordWarrantyStatus,
  recordIssueType,
  provideSolution,
  escalateToHuman,
];

const model = new ChatOpenAI({
  model: "gpt-5-mini",
});

// ä½¿ç”¨åŸºäºæ­¥éª¤çš„é…ç½®åˆ›å»ºæ™ºèƒ½ä½“
const agent = createAgent({
  model,
  tools: allTools,
  middleware: [applyStepMiddleware],
  checkpointer: new MemorySaver(),
});

// æ­¤å¯¹è¯çº¿ç¨‹çš„é…ç½®
const threadId = uuidv4();
const config = { configurable: { thread_id: threadId } };

// ç¬¬ 1 è½®ï¼šåˆå§‹æ¶ˆæ¯ - ä» warranty_collector æ­¥éª¤å¼€å§‹
console.log("=== Turn 1: Warranty Collection ===");
let result = await agent.invoke(
  { messages: [new HumanMessage("Hi, my phone screen is cracked")] },
  config
);
for (const msg of result.messages) {
  console.log(msg.content);
}

// ç¬¬ 2 è½®ï¼šç”¨æˆ·å›å¤å…³äºä¿ä¿®çš„ä¿¡æ¯
console.log("\n=== Turn 2: Warranty Response ===");
result = await agent.invoke(
  { messages: [new HumanMessage("Yes, it's still under warranty")] },
  config
);
for (const msg of result.messages) {
  console.log(msg.content);
}
console.log(`Current step: ${result.currentStep}`);

// ç¬¬ 3 è½®ï¼šç”¨æˆ·æè¿°é—®é¢˜
console.log("\n=== Turn 3: Issue Description ===");
result = await agent.invoke(
  {
    messages: [
      new HumanMessage("The screen is physically cracked from dropping it"),
    ],
  },
  config
);
for (const msg of result.messages) {
  console.log(msg.content);
}
console.log(`Current step: ${result.currentStep}`);

// ç¬¬ 4 è½®ï¼šè§£å†³æ–¹æ¡ˆ
console.log("\n=== Turn 4: Resolution ===");
result = await agent.invoke(
  { messages: [new HumanMessage("What should I do?")] },
  config
);
for (const msg of result.messages) {
  console.log(msg.content);
}
```
:::
</Expandable>

## åç»­æ­¥éª¤

- äº†è§£ç”¨äºé›†ä¸­ç¼–æ’çš„[å­æ™ºèƒ½ä½“æ¨¡å¼](/oss/langchain/multi-agent/subagents-personal-assistant)
- æ¢ç´¢[ä¸­é—´ä»¶](/oss/langchain/middleware)ä»¥è·å–æ›´å¤šåŠ¨æ€è¡Œä¸º
- é˜…è¯»[å¤šæ™ºèƒ½ä½“æ¦‚è¿°](/oss/langchain/multi-agent)ä»¥æ¯”è¾ƒä¸åŒæ¨¡å¼
- ä½¿ç”¨ [LangSmith](https://smith.langchain.com) æ¥è°ƒè¯•å’Œç›‘æ§æ‚¨çš„å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ
