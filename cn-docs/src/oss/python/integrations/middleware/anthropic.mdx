---
title: Anthropic 中间件
---
专为 Anthropic 的 Claude 模型设计的中间件。了解更多关于[中间件](/oss/langchain/middleware/overview)的信息。

| 中间件 | 描述 |
|------------|-------------|
| [提示词缓存](#prompt-caching) | 通过缓存重复的提示词前缀来降低成本 |
| [Bash 工具](#bash-tool) | 通过本地命令执行来使用 Claude 原生的 bash 工具 |
| [文本编辑器](#text-editor) | 为文件编辑提供 Claude 的文本编辑器工具 |
| [记忆](#memory) | 为持久化的智能体记忆提供 Claude 的记忆工具 |
| [文件搜索](#file-search) | 为基于状态的文件系统提供搜索工具 |

## 中间件 vs 工具

`langchain-anthropic` 提供了两种使用 Claude 原生工具的方式：

- **中间件**（本页）：具有内置执行、状态管理和安全策略的生产就绪实现
- **工具**（通过 [`bind_tools`](/oss/integrations/chat/anthropic#built-in-tools)）：低层级的构建块，需要您提供自己的执行逻辑

### 何时使用哪种

| 使用场景 | 推荐 | 原因 |
|----------|-------------|-----|
| 使用 bash 的生产环境智能体 | 中间件 | 持久化会话、Docker 隔离、输出脱敏 |
| 基于状态的文件编辑 | 中间件 | 内置 LangGraph 状态持久化 |
| 文件系统文件编辑 | 中间件 | 写入磁盘并包含路径验证 |
| 自定义执行逻辑 | 工具 | 完全控制执行过程 |
| 快速原型 | 工具 | 更简单，自带回调函数 |
| 非智能体场景下使用 @[`bind_tools`][ChatAnthropic.bind_tools] | 工具 | 中间件需要 @[`create_agent`] |

### 功能对比

| 功能 | 中间件 | 工具 |
|---------|:----------:|:-----:|
| 与 @[`create_agent`] 配合使用 | ✅ | ✅ |
| 与 @[`bind_tools`][ChatAnthropic.bind_tools] 配合使用 | ❌ | ✅ |
| 内置状态管理 | ✅ | ❌ |
| 自定义执行回调函数 | ❌ | ✅ |

<Accordion title="示例：中间件与工具对比">

**使用中间件**（开箱即用的解决方案）：

```python
from langchain_anthropic import ChatAnthropic
from langchain_anthropic.middleware import ClaudeBashToolMiddleware
from langchain.agents import create_agent
from langchain.agents.middleware import DockerExecutionPolicy

# 生产就绪，包含 Docker 隔离、会话管理等
agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    middleware=[
        ClaudeBashToolMiddleware(
            workspace_root="/workspace",
            execution_policy=DockerExecutionPolicy(image="python:3.11"),
            startup_commands=["pip install pandas"],
        ),
    ],
)
```

**使用工具**（自带执行逻辑）：

```python
import subprocess

from anthropic.types.beta import BetaToolBash20250124Param
from langchain_anthropic import ChatAnthropic
from langchain.agents import create_agent
from langchain.tools import tool

tool_spec = BetaToolBash20250124Param(
    name="bash",
    type="bash_20250124",
    strict=True,
)

@tool(extras={"provider_tool_definition": tool_spec})
def bash(*, command: str, restart: bool = False, **kw):
    """Execute a bash command."""
    if restart:
        return "Bash session restarted"
    try:
        result = subprocess.run(
            command,
            shell=True,
            capture_output=True,
            text=True,
            timeout=30,
        )
        return result.stdout + result.stderr
    except Exception as e:
        return f"Error: {e}"


agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    tools=[bash],
)

result = agent.invoke(
    {"messages": [{"role": "user", "content": "List files in this directory"}]}
)
print(result["messages"][-1].content)
```

</Accordion>

---

## 提示词缓存

通过在 Anthropic 服务器上缓存静态或重复的提示词内容（如系统提示词、工具定义和对话历史记录）来降低成本和延迟。此中间件实现了**对话式缓存策略**，在最近的消息之后放置缓存断点，允许整个对话历史记录（包括最新的用户消息）被缓存并在后续的 API 调用中重复使用。

提示词缓存在以下场景中很有用：

- 具有长且静态的系统提示词，在请求之间不会改变的应用
- 具有许多工具定义，在多次调用中保持不变的智能体
- 早期消息历史记录在多轮对话中被重复使用的对话
- 高流量部署，降低 API 成本和延迟至关重要

<Info>
    了解更多关于 [Anthropic 提示词缓存](https://platform.claude.com/docs/en/build-with-claude/prompt-caching#cache-limitations) 的策略和限制。
</Info>

**API 参考：** @[`AnthropicPromptCachingMiddleware`]

```python
from langchain_anthropic import ChatAnthropic
from langchain_anthropic.middleware import AnthropicPromptCachingMiddleware
from langchain.agents import create_agent

agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    system_prompt="<Your long system prompt here>",
    middleware=[AnthropicPromptCachingMiddleware(ttl="5m")], # [!code highlight]
)
```

<Accordion title="配置选项">

<ParamField body="type" type="string" default="ephemeral">
    缓存类型。目前仅支持 `'ephemeral'`。
</ParamField>

<ParamField body="ttl" type="string" default="5m">
    缓存内容的生存时间。有效值：`'5m'` 或 `'1h'`
</ParamField>

<ParamField body="min_messages_to_cache" type="number" default="0">
    开始缓存前所需的最小消息数量
</ParamField>

<ParamField body="unsupported_model_behavior" type="string" default="warn">
    使用非 Anthropic 模型时的行为。选项：`'ignore'`、`'warn'` 或 `'raise'`
</ParamField>

</Accordion>

<Accordion title="完整示例">

该中间件会缓存每个请求中直到最新消息（包括该消息）的内容。在 TTL 窗口（5 分钟或 1 小时）内的后续请求中，之前已见的内容将从缓存中检索，而不是重新处理，从而显著降低成本和延迟。

**工作原理：**
1. 第一个请求：系统提示词、工具和用户消息 *"Hi, my name is Bob"* 被发送到 API 并缓存
2. 第二个请求：缓存的内容（系统提示词、工具和第一条消息）从缓存中检索。只有新消息 *"What's my name?"* 需要处理，再加上模型对第一个请求的响应
3. 这种模式在每一轮对话中持续，每个请求都重用缓存的对话历史记录

<Note>
    提示词缓存通过缓存令牌来降低 API 成本，但**不**提供对话记忆功能。要在多次调用间持久化对话历史记录，请使用像 `MemorySaver` 这样的 [检查点保存器](https://langchain-ai.github.io/langgraph/concepts/persistence/#checkpointer-libraries)。
</Note>

```python
from langchain_anthropic import ChatAnthropic
from langchain_anthropic.middleware import AnthropicPromptCachingMiddleware
from langchain.agents import create_agent
from langchain.messages import HumanMessage
from langchain_core.runnables import RunnableConfig
from langgraph.checkpoint.memory import MemorySaver


LONG_PROMPT = """
Please be a helpful assistant.

<Lots more context ...>
"""

agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    system_prompt=LONG_PROMPT,
    middleware=[AnthropicPromptCachingMiddleware(ttl="5m")], # [!code highlight]
    checkpointer=MemorySaver(),  # 持久化对话历史记录
)

# 使用 thread_id 来维护对话状态
config: RunnableConfig = {"configurable": {"thread_id": "user-123"}}

# 第一次调用：创建包含系统提示词、工具和 "Hi, my name is Bob" 的缓存
agent.invoke({"messages": [HumanMessage("Hi, my name is Bob")]}, config=config)

# 第二次调用：重用缓存的系统提示词、工具和之前的消息
# 检查点保存器维护对话历史记录，因此智能体记得 "Bob"
result = agent.invoke({"messages": [HumanMessage("What's my name?")]}, config=config)
print(result["messages"][-1].content)
```

```text
Your name is Bob! You told me that when you introduced yourself at the start of our conversation.
```

</Accordion>

## Bash 工具

通过本地命令执行来使用 Claude 原生的 `bash_20250124` 工具。

Bash 工具中间件在以下场景中很有用：

- 通过本地执行使用 Claude 内置的 bash 工具
- 利用 Claude 优化的 bash 工具接口
- 需要与 Anthropic 模型进行持久化 shell 会话的智能体

<Info>
    此中间件包装了 `ShellToolMiddleware` 并将其作为 Claude 的原生 bash 工具公开。
</Info>

**API 参考：** @[`ClaudeBashToolMiddleware`]

```python
from langchain_anthropic import ChatAnthropic
from langchain_anthropic.middleware import ClaudeBashToolMiddleware
from langchain.agents import create_agent

agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    tools=[],
    middleware=[ # [!code highlight]
        ClaudeBashToolMiddleware( # [!code highlight]
            workspace_root="/workspace", # [!code highlight]
        ), # [!code highlight]
    ], # [!code highlight]
)
```

<Accordion title="配置选项">

`ClaudeBashToolMiddleware` 接受 @[`ShellToolMiddleware`] 的所有参数，包括：

<ParamField body="workspace_root" type="str | Path | None">
    shell 会话的基础目录
</ParamField>

<ParamField body="startup_commands" type="tuple[str, ...] | list[str] | str | None">
    会话启动时运行的命令
</ParamField>

<ParamField body="execution_policy" type="BaseExecutionPolicy | None">
    执行策略（`HostExecutionPolicy`、`DockerExecutionPolicy` 或 `CodexSandboxExecutionPolicy`）
</ParamField>

<ParamField body="redaction_rules" type="tuple[RedactionRule, ...] | list[RedactionRule] | None">
    用于清理命令输出的规则
</ParamField>

完整配置详情请参阅 [Shell 工具](/oss/langchain/middleware/built-in#shell-tool)。

</Accordion>

<Accordion title="完整示例">

```python
import tempfile

from langchain_anthropic import ChatAnthropic
from langchain_anthropic.middleware import ClaudeBashToolMiddleware
from langchain.agents import create_agent
from langchain.agents.middleware import DockerExecutionPolicy

# 为此演示创建一个临时工作空间目录。
# 在生产环境中，请使用持久化的目录路径。
workspace = tempfile.mkdtemp(prefix="agent-workspace-")

agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    tools=[],
    middleware=[ # [!code highlight]
        ClaudeBashToolMiddleware( # [!code highlight]
            workspace_root=workspace, # [!code highlight]
            startup_commands=["echo 'Session initialized'"], # [!code highlight]
            execution_policy=DockerExecutionPolicy( # [!code highlight]
                image="python:3.11-slim", # [!code highlight]
            ), # [!code highlight]
        ), # [!code highlight]
    ], # [!code highlight]
)

# Claude 现在可以使用其原生的 bash 工具
result = agent.invoke(
    {"messages": [{"role": "user", "content": "What version of Python is installed?"}]}
)
print(result["messages"][-1].content)
```

```text
Python 3.11.14 is installed.
```

</Accordion>


## 文本编辑器

为文件创建和编辑提供 Claude 的文本编辑器工具 (`text_editor_20250728`)。

文本编辑器中间件在以下场景中很有用：

- 基于文件的智能体工作流
- 代码编辑和重构任务
- 多文件项目工作
- 需要持久化文件存储的智能体

<Note>
    提供两种变体：**基于状态**（文件存储在 LangGraph 状态中）和**基于文件系统**（文件存储在磁盘上）。
</Note>

**API 参考：**
- @[`StateClaudeTextEditorMiddleware`]
- @[`FilesystemClaudeTextEditorMiddleware`]

```python State-based text editor
from langchain_anthropic import ChatAnthropic
from langchain_anthropic.middleware import StateClaudeTextEditorMiddleware
from langchain.agents import create_agent

agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    tools=[],
    middleware=[StateClaudeTextEditorMiddleware()], # [!code highlight]
)
```

```python Filesystem-based text editor
from langchain_anthropic import ChatAnthropic
from langchain_anthropic.middleware import FilesystemClaudeTextEditorMiddleware
from langchain.agents import create_agent

agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    tools=[],
    middleware=[ # [!code highlight]
        FilesystemClaudeTextEditorMiddleware( # [!code highlight]
            root_path="/workspace", # [!code highlight]
        ), # [!code highlight]
    ], # [!code highlight]
)
```

Claude 的文本编辑器工具支持以下命令：

- `view` - 查看文件内容或列出目录
- `create` - 创建新文件
- `str_replace` - 替换文件中的字符串
- `insert` - 在行号处插入文本
- `delete` - 删除文件
- `rename` - 重命名/移动文件

<Accordion title="配置选项">

**@[`StateClaudeTextEditorMiddleware`] (基于状态)**

<ParamField body="allowed_path_prefixes" type="Sequence[str] | None">
    允许的路径前缀的可选列表。如果指定，则只允许以这些前缀开头的路径。
</ParamField>

**@[`FilesystemClaudeTextEditorMiddleware`] (基于文件系统)**

<ParamField body="root_path" type="str" required>
    文件操作的根目录
</ParamField>

<ParamField body="allowed_prefixes" type="list[str] | None">
    允许的虚拟路径前缀的可选列表（默认：`["/"]`）
</ParamField>

<ParamField body="max_file_size_mb" type="int" default="10">
    最大文件大小（MB）
</ParamField>

</Accordion>

<AccordionGroup>

<Accordion title="完整示例：基于状态的文本编辑器">

```python
from langchain_anthropic import ChatAnthropic
from langchain_anthropic.middleware import StateClaudeTextEditorMiddleware
from langchain.agents import create_agent
from langchain_core.runnables import RunnableConfig
from langgraph.checkpoint.memory import MemorySaver


agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    tools=[],
    middleware=[
        StateClaudeTextEditorMiddleware( # [!code highlight]
            allowed_path_prefixes=["/project"], # [!code highlight]
        ), # [!code highlight]
    ],
    checkpointer=MemorySaver(),
)

# 使用 thread_id 在多次调用间持久化状态
config: RunnableConfig = {"configurable": {"thread_id": "my-session"}}

# Claude 现在可以创建和编辑文件（存储在 LangGraph 状态中）
result = agent.invoke(
    {"messages": [{"role": "user", "content": "Create a file at /project/hello.py with a simple hello world program"}]},
    config=config,
)
print(result["messages"][-1].content)
```

```text
I've created a simple "Hello, World!" program at `/project/hello.py`. The program uses Python's `print()` function to display "Hello, World!" to the console when executed.
```

</Accordion>

<Accordion title="完整示例：基于文件系统的文本编辑器">

```python
import tempfile

from langchain_anthropic import ChatAnthropic
from langchain_anthropic.middleware import FilesystemClaudeTextEditorMiddleware
from langchain.agents import create_agent


# 为此演示创建一个临时工作空间目录。
# 在生产环境中，请使用持久化的目录路径。
workspace = tempfile.mkdtemp(prefix="editor-workspace-")

agent = create_agent(
    model=ChatAnthropic(model="claude-sonnet-4-5-20250929"),
    tools=[],
    middleware=[
        FilesystemClaudeTextEditorMiddleware( # [!code highlight]
            root_path=workspace, # [!code highlight]
            allowed_prefixes=["/src"], # [!code highlight]
            max_file_size_mb=10, # [!code highlight]
        ), # [!code highlight]
    ],
)

# Claude 现在可以创建和编辑文件（存储在磁盘上）
result = agent.invoke(
    {"messages": [{"role": "user", "content": "Create a file at /src/hello.py with a simple hello world program"}]}
)
print(result["messages"][-1].content)
```

```text
I've created a simple "Hello, World!" program at `/src/hello.py`. The
